/*patched: guard kernel.graph*/ if(window.kernel&&window.kernel.graph&&Array.isArray(window.kernel.graph.nodes)){!function(e,t){"use strict";!function(){function n(){if(!e.cytoscape||!e.cytoscape.Core)return!1;const t=e.cytoscape.Core.prototype;return"function"!=typeof t.startBatch&&(t.startBatch=function(){this.___batched=!0}),"function"!=typeof t.endBatch&&(t.endBatch=function(){this.___batched=!1}),!0}function a(e){e&&("function"!=typeof e.startBatch&&(e.startBatch=function(){this.___batched=!0}),"function"!=typeof e.endBatch&&(e.endBatch=function(){this.___batched=!1}))}function o(){n(),e.cy&&a(e.cy),function(){if(!e.cytoscape||e.cytoscape.__BATCH_WRAPPED__)return;const o=e.cytoscape;e.cytoscape=function(...e){const r=o.apply(this,e);try{n(),a(r)}catch(e){}try{t.dispatchEvent(new CustomEvent("cy:ready",{detail:{cy:r}}))}catch(e){}return r},e.cytoscape.__BATCH_WRAPPED__=!0}()}e.__CY_BATCH_GUARD__||(e.__CY_BATCH_GUARD__=!0,"loading"===t.readyState?t.addEventListener("DOMContentLoaded",o,{once:!0}):o(),t.addEventListener("cy:ready",function(e){n(),a(e&&e.detail&&e.detail.cy)}))}(),function(){function n(e){if(!e||e.__SAFE_COLL_INSTALLED__)return;const t=[];function n(){e.__SAFE_COLL_LISTENERS__||(e.on("add","*",function(){try{if(!t.length)return;for(let n=t.length-1;n>=0;n--){const a=t[n],o=a.selectorPath.join(""),r=e.$(o);if(r.length>0){const e=r[a.method];if("function"==typeof e)try{e.apply(r,a.args)}catch(e){}t.splice(n,1)}}}catch(e){}}),e.__SAFE_COLL_LISTENERS__=!0)}function a(o,r){if(o||(o=e.collection()),o.__SAFE_WRAPPED__)return o;r=r||[""];const i=["add","remove","addClass","removeClass","toggleClass","style","data","animate","layout","move"],s=["filter"],c={get(e,o){if("string"==typeof o&&/^\d+$/.test(o)){const a={};return i.forEach(o=>{a[o]=function(){if(e.length>0){const t=e,n=t[o];if("function"==typeof n)return n.apply(t,arguments)}else t.push({selectorPath:r,method:o,args:Array.prototype.slice.call(arguments)}),n();return a}}),a}if(i.includes(o))return function(){if(e.length>0){const t=e[o];if("function"==typeof t)return t.apply(e,arguments)}else t.push({selectorPath:r,method:o,args:Array.prototype.slice.call(arguments)}),n();return a(e,r)};if(s.includes(o))return function(){const t=Array.prototype.slice.call(arguments),n="string"==typeof t[0]?t[0]:"",i=r.concat([n]);return a(e[o].apply(e,t),i)};const c=e[o];return"function"==typeof c?c.bind(e):c}},l=new Proxy(o,c);return l.__SAFE_WRAPPED__=!0,l}const o={elements:e.elements.bind(e),nodes:e.nodes.bind(e),edges:e.edges.bind(e),$:e.$.bind(e),getElementById:e.getElementById.bind(e),collection:e.collection.bind(e)};e.elements=function(e){return a(o.elements(e),[""+(e||"")])},e.nodes=function(e){return a(o.nodes(e),[""+(e||"")])},e.edges=function(e){return a(o.edges(e),[""+(e||"")])},e.$=function(e){return a(o.$(e),[""+(e||"")])},e.getElementById=function(e){return a(o.getElementById(e),["[#"+e+"]"])},e.__SAFE_COLL_INSTALLED__=!0}function a(){try{if(e.cy&&n(e.cy),e.cytoscape&&!e.cytoscape.__SAFE_WRAP_COLLECTIONS__){const t=e.cytoscape;e.cytoscape=function(){const e=t.apply(this,arguments);try{n(e)}catch(e){}return e},e.cytoscape.__SAFE_WRAP_COLLECTIONS__=!0}}catch(e){}}e.__CY_COLL_GUARD__||(e.__CY_COLL_GUARD__=!0,"loading"===t.readyState?t.addEventListener("DOMContentLoaded",a,{once:!0}):a(),t.addEventListener("cy:ready",function(e){try{n(e&&e.detail&&e.detail.cy)}catch(e){}}))}(),function(){function n(e){if(!e||e.__SAFE_ADD_INSTALLED__)return;const t={add:e.add.bind(e),json:e.json.bind(e),$:e.$.bind(e),id:t=>e.getElementById?e.getElementById(t):e.$("#"+t)},n=[];function a(e){if(null==e)return!1;const n=t.id(String(e));return!!(n&&n.length&&n.length>0)}function o(e){return e&&("nodes"===e.group||e.data&&e.data.id&&!e.data.source&&!e.data.target)}function r(e){return e&&("edges"===e.group||e.data&&e.data.source&&e.data.target)}function i(e){return"string"==typeof e?{passthrough:e}:Array.isArray(e)?s(e):e&&e.elements?s(e.elements):e&&(o(e)||r(e))?s([e]):{passthrough:e}}function s(e){const t=[],n=[];for(const a of e||[])r(a)?n.push(c(a)):o(a)&&t.push(c(a));return{nodes:t,edges:n}}function c(e){try{return JSON.parse(JSON.stringify(e))}catch(t){return e}}function l(e){const t=[],n=new Set;for(const a of e||[]){const e=a&&a.data&&a.data.id;e&&!n.has(e)&&(n.add(e),t.push(a))}return t}function d(n){if(!n||!n.length)return e.collection();const o=n.filter(e=>!a(e&&e.data&&e.data.id));if(!o.length)return e.collection();try{e.startBatch&&e.startBatch()}catch(e){}const r=t.add(o);try{e.endBatch&&e.endBatch()}catch(e){}return r}function u(o){if(!o||!o.length)return e.collection();const r=[],i=[];for(const e of o){const t=e&&e.data&&e.data.source,n=e&&e.data&&e.data.target;a(t)&&a(n)?r.push(e):i.push(e)}let s=e.collection();if(r.length){try{e.startBatch&&e.startBatch()}catch(e){}s=t.add(r);try{e.endBatch&&e.endBatch()}catch(e){}}return i.length&&(n.push.apply(n,i),setTimeout(function(){if(!n.length)return;try{e.startBatch&&e.startBatch()}catch(e){}const o=n.splice(0,n.length),r=[],i=[];for(const e of o){const t=e&&e.data&&e.data.source,n=e&&e.data&&e.data.target;a(t)&&a(n)?r.push(e):i.push(e)}if(r.length)try{t.add(r)}catch(e){}i.length&&n.push.apply(n,i);try{e.endBatch&&e.endBatch()}catch(e){}},0)),s}function p(){e.__SAFE_ADD_REPLAY__||(e.on("add","node",function(){if(!n.length)return;try{e.startBatch&&e.startBatch()}catch(e){}u(n.splice(0,n.length));try{e.endBatch&&e.endBatch()}catch(e){}}),e.__SAFE_ADD_REPLAY__=!0)}e.add=function(e){const n=i(e);if(void 0!==n.passthrough)return t.add(n.passthrough);const a=l(n.nodes),o=l(n.edges),r=d(a),s=u(o);return p(),r.union(s)},e.json=function(n){if(n&&n.elements){const a=i(n),o=l(a.nodes),r=l(a.edges);try{e.startBatch&&e.startBatch()}catch(e){}e.elements().remove(),d(o),u(r);try{e.endBatch&&e.endBatch()}catch(e){}return p(),t.json({elements:e.elements().jsons()})}return t.json(n)},e.__SAFE_ADD_INSTALLED__=!0}function a(){try{if(e.cy&&n(e.cy),e.cytoscape&&!e.cytoscape.__SAFE_ADD_WRAP__){const t=e.cytoscape;e.cytoscape=function(){const e=t.apply(this,arguments);try{n(e)}catch(e){}return e},e.cytoscape.__SAFE_ADD_WRAP__=!0}}catch(e){}}e.__CY_SAFE_ADD__||(e.__CY_SAFE_ADD__=!0,"loading"===t.readyState?t.addEventListener("DOMContentLoaded",a,{once:!0}):a(),t.addEventListener("cy:ready",function(e){try{n(e&&e.detail&&e.detail.cy)}catch(e){}}))}(),function(){if(!e.__CY_STUB__){e.__CY_STUB__=!0;var n=function(){},a=function(e){return Array.prototype.slice.call(e||[])},o=[],r=null,i={elements:function(e){return p(c({type:"elements",value:e}))},nodes:function(e){return p(c({type:"elements",value:e}))},edges:function(e){return p(c({type:"elements",value:e}))},getElementById:function(e){return p(c({type:"id",value:String(e)}))},$:function(e){return p(c({type:"query",value:String(e)}))},on:n,off:n,startBatch:n,endBatch:n,batch:function(e){try{"function"==typeof e&&e.call(this)}catch(e){}},fit:function(){s("cy","fit",arguments)},add:function(){s("cy","add",arguments)},remove:function(){s("cy","remove",arguments)},addClass:function(){s("cy","addClass",arguments)},removeClass:function(){s("cy","removeClass",arguments)},style:function(){s("cy","style",arguments)},reset:function(){s("cy","reset",arguments)},layout:function(){s("cy","layout",arguments)}};try{Object.defineProperty(e,"cy",{configurable:!0,get:function(){return r||i},set:function(e){u(r=e)}})}catch(t){e.cy=e.cy||i}t.addEventListener("cy:ready",function(e){var t=e&&e.detail&&e.detail.cy;if(t)try{u(r=t)}catch(e){}}),setTimeout(function(){try{e.cy&&e.cy!==i&&u(e.cy)}catch(e){}},200)}function s(e,t,n,r){o.push({kind:e,method:t,args:a(n),selectorRef:r||null})}function c(e){return{type:e.type,value:e.value,ops:[]}}function l(e,t){return t?"id"===t.type?e.getElementById(String(t.value)):"query"===t.type?e.$(String(t.value)):e.elements(t.value):e.elements()}function d(e,t){for(var n=e,o=0;o<(t||[]).length;o++){var r=t[o];n&&"function"==typeof n[r.method]&&(n=n[r.method].apply(n,a(r.args)))}return n}function u(e){if(e&&o.length){try{for(var t=0;t<o.length;t++){var n=o[t];if("cy"===n.kind){var a=e[n.method];"function"==typeof a&&a.apply(e,n.args)}else if("collection"===n.kind){var r=d(l(e,n.selectorRef),n.selectorRef&&n.selectorRef.ops||[]),i=r&&r[n.method];"function"==typeof i&&i.apply(r,n.args)}}}catch(e){}o.length=0}}function p(e){for(var t={},a=["filter"],o=0;o<a.length;o++)(function(n){t[n]=function(){return e.ops.push({method:n,args:arguments}),t}})(a[o]);for(var r=["add","remove","addClass","removeClass","toggleClass","style","data","animate","layout","move"],i=0;i<r.length;i++)(function(n){t[n]=function(){return s("collection",n,arguments,e),t}})(r[i]);t.forEach=n,t.map=function(){return[]};try{Object.defineProperty(t,"length",{get:function(){return 0}})}catch(e){t.length=0}t[0]=t;try{Object.defineProperty(t,1,{get:function(){return t}}),Object.defineProperty(t,2,{get:function(){return t}})}catch(e){}return t}}(),e.__CLD_RT_GUARD__||(e.__CLD_RT_GUARD__=!0,e.onCyReady||(e.__CLD_READY__=!1,e.onCyReady=function(n){const a=e=>{if(e&&"function"==typeof n)try{n(e)}catch(e){}};e.cy&&"function"==typeof e.cy.on?a(e.cy):e.__CLD_READY__||(e.__CLD_READY__=!0,t.addEventListener("cy:ready",t=>a(t&&t.detail&&t.detail.cy||e.cy),{once:!0}),e.whenModelReady&&e.whenModelReady(()=>a(e.cy)),"loading"!==t.readyState?setTimeout(()=>a(e.cy),0):t.addEventListener("DOMContentLoaded",()=>a(e.cy),{once:!0}))}),e.__cldDebounce||(e.__cldDebounce=function(e,t=60){let n=0;return function(){const a=arguments;clearTimeout(n),n=setTimeout(()=>e.apply(this,a),t)}}),e.__cldSafeFit||(e.__cldSafeFit=function(e){try{const t=e?.elements();if(!t||0===t.length)return;e.fit(t,40)}catch(e){}})),function(){if(e.__A11Y_BOUND__)return;e.__A11Y_BOUND__=!0;const n=(e,n=t)=>n.querySelector(e),a=(e,n=t)=>Array.from(n.querySelectorAll(e)),o=(e,t,n)=>{e&&!e.hasAttribute(t)&&e.setAttribute(t,n)};function r(){a('button, [role="button"], a[href], input, select, textarea').forEach(e=>{if(!(e.hasAttribute("aria-label")||e.hasAttribute("aria-labelledby")||(e=>!(!e||!(e.textContent||"").trim().length))(e)||!!e.getAttribute("title"))){const t=e.dataset?.label||e.placeholder||e.name||e.id||"دکمه بدون برچسب";o(e,"aria-label",t)}"button"===e.getAttribute("role")&&e.setAttribute("tabindex",e.getAttribute("tabindex")||"0")})}function i(){a('button, .btn, .btn-soft, [role="button"], .icon-btn').forEach(e=>{const t=e.getBoundingClientRect();(t.width<44||t.height<44)&&(e.classList.add("a11y-touch"),/icon/i.test(e.className)&&e.classList.add("round"))})}function s(){var a=function(e){const a=n("#cy")||n(".cytoscape-container")||n(".cy-container")||n("#cld-canvas")||e&&e.container&&e.container(),r=(a&&a.nodeType?a:null)||e&&e.container&&e.container();if(!r||r.__a11y_done)return;r.__a11y_done=!0,r.classList.add("cy-a11y-focus"),o(r,"tabindex","0"),o(r,"role","application");const i="cy-a11y-desc";if(!n("#"+i)){const e=t.createElement("div");e.id=i,e.className="sr-only",e.textContent="بوم تعامل‌پذیر نمودار علّی. برای جابه‌جایی از ماوس/لمس استفاده کنید؛ برای بزرگ‌نمایی از Ctrl+اسکرول. برای خروج از بوم، کلید Tab را فشار دهید.",t.body.appendChild(e)}o(r,"aria-describedby",i),o(r,"aria-label","نمودار علّی-حلقه‌ای (CLD)")};if(e.graphStore&&"function"==typeof e.graphStore.run)graphStore.run(a);else if(e.cy&&"function"==typeof e.cy.container)try{a(e.cy)}catch(e){}}function c(){!function(){if(n("#a11y-skip"))return;const e=t.createElement("a");e.id="a11y-skip",e.className="a11y-skiplink",e.href="#main-content",e.textContent="پرش به محتوای اصلی",t.body.appendChild(e);let a=n("#main-content")||n("main")||n("#hero-kpi");if(!a){a=t.createElement("div"),a.id="main-content";const e=n("#hero-kpi")||n("header")||t.body;e.parentElement?.insertBefore(a,e)}}(),r(),a('[role="button"]').forEach(e=>{e.__a11y_keybound||(e.__a11y_keybound=!0,e.addEventListener("keydown",t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),e.click?.())}))}),i(),s(),a('.legend-sticky, .legend, [aria-hidden="true"]').forEach(e=>{"none"!==getComputedStyle(e).display&&(e.matches('a,button,input,select,textarea,[role="button"]')||o(e,"tabindex","-1"))})}"complete"===t.readyState||"interactive"===t.readyState?c():e.addEventListener("DOMContentLoaded",c,{once:!0}),t.addEventListener("model:updated",()=>{r(),i(),s()})}(),function(){if(e.__AHA_METRICS__)return;e.__AHA_METRICS__=!0;const n=e.localStorage;let a=null,o=!1;function r(e){try{const t=JSON.parse(n.getItem("aha_events")||"[]");t.push({name:e,t:Date.now()}),n.setItem("aha_events",JSON.stringify(t))}catch(e){}}function i(){["p-eff","p-dem","p-delay","btn-run","btn-run-sample"].forEach(e=>{const o=t.getElementById(e);if(!o)return;const i="INPUT"===o.tagName?"input":"click";o.addEventListener(i,()=>{!function(){if(null==a){a=Date.now();try{n.setItem("aha_start_ts",String(a))}catch(e){}}}(),r("start")},{once:!0})})}t.addEventListener("model:updated",()=>{r("delta-shown"),function(){if(o||null==a)return;o=!0;const e=Date.now()-a;try{n.setItem("aha_time_ms",String(e))}catch(e){}console.info("[AHA]",e,"ms")}()}),"loading"!==t.readyState?i():e.addEventListener("DOMContentLoaded",i,{once:!0})}(),function(){if(e.__AHA_BOUND__)return;e.__AHA_BOUND__=!0;const n={version:e.MODEL_VERSION||"v1.0",target:{kpi:"supply_demand_gap",value:10,year:"۱۴۰۵"},highlightMs:1500,sample:{text:"اجرای سناریوی نمونه: کاهش تلفات ۳۰→۲۰٪",apply:async function(){if(e.ModelBridge?.setParam)try{const n=c(["leakage_rate","leakage","loss_rate","nrw"]);if(n){const a=s(n)?20:.2;return e.ModelBridge.setParam(n,function(e,t){const n=r(e);return i(n,t)}(n,a)),await(e.ModelBridge.rerunModel?.()),void t.dispatchEvent(new CustomEvent("scenario:applied",{detail:{id:"leakage20"}}))}}catch(e){}const n=c(["leakage_rate","leakage","loss_rate","nrw"]);if(n){const e=r(n);if(e){const a=s(n);e.value=String(i(e,a?20:.2)),e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0})),t.dispatchEvent(new CustomEvent("model:updated",{detail:{source:"aha-sample"}}))}}}},kpiSpec:{supply_demand_gap:{unit:"%",better:"lower"},per_capita_use:{unit:"L/day",better:"lower"},leakage_rate:{unit:"%",better:"lower"}}},a=(e,n=t)=>n.querySelector(e),o=(e,n=t)=>Array.from(n.querySelectorAll(e));function r(e){return t.querySelector(`[data-param="${e}"]`)||t.getElementById(e)||t.querySelector(`input[name="${e}"], select[name="${e}"]`)}function i(e,t){if(!e)return t;const n=""!==e.min?Number(e.min):null,a=""!==e.max?Number(e.max):null;let o=Number(t);return null!=n&&o<n&&(o=n),null!=a&&o>a&&(o=a),o}function s(e){const t=r(e);if(!t)return!1;const n=""!==t.max?Number(t.max):null;return null!=n&&n>1.5}function c(e){for(const t of e)if(r(t))return t;return null}function l(t){try{if(e.ModelBridge?.getKPI){const n=e.ModelBridge.getKPI(t);if(null!=n)return Number(n)}}catch(e){}const n=function(){const e={};return o("[data-param]").forEach(t=>{const n=t.dataset.param;if(!n)return;const a="checkbox"===t.type?t.checked?1:0:Number(t.value??t.getAttribute("value"));Number.isNaN(a)||(e[n]=a)}),e}();if("per_capita_use"===t&&null!=n.dem)return+(350*Number(n.dem)).toFixed(1);if("leakage_rate"===t){if(null!=n.leakage_rate)return+Number(n.leakage_rate).toFixed(1);if(null!=n.eff){const e=24.8;return+Math.max(0,e*(1-.2*(Number(n.eff)-.3))).toFixed(1)}}if("supply_demand_gap"===t&&null!=n.dem&&null!=n.eff){const e=Math.max(.01,Number(n.dem)),t=Math.max(.01,.7*Number(n.eff)+.3);return+Math.max(0,(e-t)/Math.max(e,1)*100).toFixed(1)}return null}const d=`aha_baseline_${n.version}`;function u(){try{const e=sessionStorage.getItem(d);return e?JSON.parse(e):null}catch(e){return null}}function p(e){try{sessionStorage.setItem(d,JSON.stringify({t:Date.now(),kpis:e}))}catch(e){}}function f(){const e=u();o("#hero-kpi .kpi").forEach(t=>{const a=t.dataset.kpi||function(e){const t=(e.querySelector(".kpi-title")?.textContent||"").trim();return/عرضه.?تقاضا|gap/i.test(t)?"supply_demand_gap":/سرانه|per.?capita/i.test(t)?"per_capita_use":/تلفات|leak/i.test(t)?"leakage_rate":null}(t),o=n.kpiSpec[a];if(!a||!o)return;const r=l(a);if(!e||!e.kpis||null==e.kpis[a]){const e={};return Object.keys(n.kpiSpec).forEach(t=>{e[t]=l(t)}),void p(e)}const i=Number(e.kpis[a]),s=(Number(r)-i)/(Math.abs(i)<1e-9?1:i)*100,c="lower"===(o.better||"lower");let d="neutral",u="↔";Math.abs(s)<.05?(d="neutral",u="↔"):s<0&&c||s>0&&!c?(d="pos",u="↓"):(d="neg",u="↑");const f=t.querySelector(".kpi-delta");f&&(f.classList.remove("pos","neg","neutral"),f.classList.add("show",d,"kpi-ping"),f.querySelector(".arrow").textContent=u,f.querySelector(".val").textContent=`${Math.abs(s).toFixed(1)}%`,setTimeout(()=>f.classList.remove("kpi-ping"),n.highlightMs))})}function h(){if(function(){const e=a("#hero-kpi .problem-text")||a("#hero-kpi")||t.body;if(!e||a("#hero-objective"))return;const o=t.createElement("div");var r;o.id="hero-objective",o.className="hero-objective",o.textContent=`هدف: کاهش «${r=n.target.kpi,{supply_demand_gap:"شکاف عرضه–تقاضا",per_capita_use:"مصرف سرانه",leakage_rate:"نرخ تلفات شبکه"}[r]||r}» به ${n.target.value}% تا ${n.target.year}.`,e.appendChild(o)}(),function(){const e=a("#hero-kpi .baseline-row")||a("#hero-kpi")||null;if(!e)return;const r=a("#btn-run-sample")||o("button").find(e=>/اجرای.*سناریو|Run.*sample/i.test(e.textContent||""));if(r)return void r.classList.add("btn-primary-aha");const i=t.createElement("button");i.type="button",i.id="btn-run-sample",i.className="btn-primary-aha",i.textContent=n.sample.text,i.addEventListener("click",n.sample.apply),e.appendChild(i)}(),o("#hero-kpi .kpi").forEach(e=>{if(e.querySelector(".kpi-delta"))return;const n=t.createElement("div");n.className="kpi-delta",n.innerHTML='<span class="arrow">±</span><span class="val">—</span>',e.appendChild(n)}),!u()){const e={};Object.keys(n.kpiSpec).forEach(t=>{e[t]=l(t)}),p(e)}f(),function(){if(e.__CLD_TOUR_BOUND__)return;if("1"===sessionStorage.getItem("aha_tour_hint"))return;const n=a("#hero-kpi")||t.body,o=t.createElement("div");o.className="hero-objective",o.style.marginTop="6px",o.innerHTML="راهنمای سه‌مرحله‌ای در دسترس است؛ برای مشاهده، به انتهای آدرس <code>?tour=1</code> اضافه کنید.",n.appendChild(o),sessionStorage.setItem("aha_tour_hint","1")}()}t.addEventListener("model:updated",f),t.addEventListener("scenario:applied",f),"complete"===t.readyState||"interactive"===t.readyState?h():e.addEventListener("DOMContentLoaded",h,{once:!0})}(),function(){if(e.__CTL_META_BOUND__)return;e.__CTL_META_BOUND__=!0;const n=(e,n=t)=>Array.from(n.querySelectorAll(e)),a=e=>(e||"").replace(/\s+/g," ").trim(),o=e=>a(e?.textContent||""),r=(e,t)=>t.some(t=>t.test(e));function i(e){if(e.closest(".ctl-chip"))return e.closest(".ctl-chip");const n=function(e){const t=e.closest("label")?.innerText||e.getAttribute("aria-label")||e.name||e.id||e.dataset?.param||e.placeholder||"کنترل";let n=e.dataset?.unit||"";const o=(e.closest("label")?.innerText||e.parentElement?.innerText||"").toLowerCase();n||(/%|درصد|percent|rate/i.test(o)?n="%":/سال|year/i.test(o)?n="سال":/روز|day/i.test(o)&&(n="روز"));let r=null,i=null;if("INPUT"===e.tagName||"SELECT"===e.tagName){const t=(e.type||"").toLowerCase();(["range","number"].includes(t)||"SELECT"===e.tagName)&&(r={min:e.min??"",max:e.max??"",step:e.step??""},i=e.getAttribute("value")??e.defaultValue??e.value??"")}return{label:a(t),unit:n,rng:r,def:i}}(e),o=t.createElement("div");o.className="ctl-chip";const r=t.createElement("span");r.className="ctl-title",r.textContent=n.label,o.appendChild(r),o.appendChild(t.createElement("span")).className="sep",o.appendChild(e);const i=t.createElement("span");if(n.unit){const e=t.createElement("span");e.className="unit",e.textContent=n.unit,i.appendChild(e)}if(n.rng){const e=t.createElement("span");e.className="rng",e.textContent=`min:${n.rng.min||"—"} • max:${n.rng.max||"—"} • step:${n.rng.step||"—"}`,i.appendChild(t.createTextNode(" ")),i.appendChild(e);const a=t.createElement("span");a.className="def",a.textContent=` • default:${n.def||"—"}`,i.appendChild(a)}return i.childNodes.length&&o.appendChild(i),o}function s(e){if(!e||e.__processed)return;e.__processed=!0,function(e){if(!e||e.__hdr_done)return;e.__hdr_done=!0;const a=e.querySelector('summary, .title, .header, h3, h4, [role="heading"]');if(!a)return;a.classList.add("controls-meta-header"),e.classList.add("controls-meta-card");let r=t.createElement("span");r.className="controls-meta-count",r.textContent="",a.appendChild(r);let i=t.createElement("button");i.type="button",i.className="controls-help-btn",i.textContent="راهنما",a.appendChild(i);let s=t.createElement("div");s.className="controls-help-pop",s.innerHTML="<ul></ul>",e.appendChild(s);const c=[];if(n("*",e).forEach(e=>{if("?"===o(e)||e.dataset?.help){const t=e.dataset?.help||e.getAttribute("title")||"راهنمای این کنترل";c.push(t),e.style.display="none"}}),c.length){const e=s.querySelector("ul");c.forEach(n=>{const a=t.createElement("li");a.textContent=n,e.appendChild(a)})}else i.style.display="none";i.addEventListener("click",e=>{e.stopPropagation(),s.style.display="block"===s.style.display?"none":"block"}),t.addEventListener("click",()=>s.style.display="none")}(e);const a=e.querySelector(".ac-body, .controls, .body, .content")||e,r=n("input, select",a).filter(e=>!e.closest(".ctl-chip"));r.length?e.classList.remove("card-collapsed"):e.classList.add("card-collapsed"),r.forEach(e=>{const t=i(e);t&&!t.parentElement&&a.appendChild(t)});const s=()=>{const t=function(e){let t=0;return n("input, select",e).forEach(e=>{const n=e.getAttribute("value")??e.defaultValue;if("checkbox"===e.type){const a=!!e.hasAttribute("checked")||!!n&&"1"===n;e.checked!==a&&t++}else null!=n&&String(e.value)!==String(n)&&t++}),t}(e),a=e.querySelector(".controls-meta-count");if(a){const n=o(e.querySelector('summary, .title, .header, h3, h4, [role="heading"]'))||"";/filter|فیلتر/i.test(n)?a.textContent=t?`(${t} فعال)`:"(۰ فعال)":a.textContent=t?`(${t} تغییر)`:""}};s(),e.__meta_oninput&&e.removeEventListener("input",e.__meta_oninput),e.__meta_onchange&&e.removeEventListener("change",e.__meta_onchange),e.__meta_oninput=()=>s(),e.__meta_onchange=()=>s(),e.addEventListener("input",e.__meta_oninput),e.addEventListener("change",e.__meta_onchange)}function c(){const{mode:e,filter:t,layout:a}=function(){const e=n("section, div, .ac-card, .card, details"),t={mode:null,filter:null,layout:null};return e.forEach(e=>{const n=o(e.querySelector('summary, .title, .header, h3, h4, [role="heading"]'));if(!n)return;const a=n.toLowerCase();!t.mode&&r(a,[/mode|حالت/i])&&(t.mode=e),!t.filter&&r(a,[/filter|فیلتر/i])&&(t.filter=e),!t.layout&&r(a,[/layout|چیدمان/i])&&(t.layout=e)}),t}();[e,t,a].forEach(s)}"complete"===t.readyState||"interactive"===t.readyState?c():e.addEventListener("DOMContentLoaded",c,{once:!0})}(),function(){function n(){try{Object.defineProperty(e,"c",{configurable:!0,get:function(){return e.cy},set:function(t){try{e.cy=t}catch(e){}}})}catch(t){e.c=e.cy}}e.__CY_ALIAS__||(e.__CY_ALIAS__=!0,n(),t.addEventListener("cy:ready",n),setTimeout(function(){try{e.cy&&"function"==typeof e.cy.add&&t.dispatchEvent(new CustomEvent("cy:ready",{detail:{cy:e.cy}}))}catch(e){}},0))}(),function(){if(e.__DELTA_KPI__)return;e.__DELTA_KPI__=!0;const n=e.localStorage;function a(e,n=t){return Array.from(n.querySelectorAll(e))}function o(){a(".kpi").forEach(e=>{if(!e.querySelector(".delta-chip")){const n=t.createElement("span");n.className="delta-chip delta-zero",n.textContent="0%",e.appendChild(n)}})}function r(){try{const e=n.getItem("kpi_base_v1");if(e)return JSON.parse(e)}catch(e){}const e=function(){const e={};return a(".kpi").forEach(t=>{const n=t.dataset.kpi||t.querySelector(".kpi-title")?.textContent?.trim(),a=parseFloat(t.querySelector(".kpi-value .val")?.textContent||"0");n&&(e[n]=a)}),e}();try{n.setItem("kpi_base_v1",JSON.stringify(e))}catch(e){}return e}function i(e){let n={k:null,d:0,val:0};a(".kpi").forEach(t=>{const a=t.dataset.kpi||t.querySelector(".kpi-title")?.textContent?.trim(),o=parseFloat(t.querySelector(".kpi-value .val")?.textContent||"0"),r=e[a];if("number"!=typeof r)return;const i=(o-r)/Math.max(Math.abs(r),1e-9)*100,s=t.querySelector(".delta-chip");if(!s)return;let c="delta-zero",l="0%";Math.abs(i)>=.1&&(c=i>=0?"delta-up":"delta-down",l=(i>=0?"+":"")+i.toFixed(1)+"%"),s.className="delta-chip "+c,s.textContent=l,Math.abs(i)>Math.abs(n.d)&&(n={k:a,d:i,val:o})}),Math.abs(n.d)>=1&&function(e){let n=t.getElementById("kpi-toast");n||(n=t.createElement("div"),n.id="kpi-toast",n.className="toast",t.body.appendChild(n)),n.textContent=e,n.classList.add("show"),setTimeout(()=>n.classList.remove("show"),3e3)}(`اثر سناریو روی «${n.k}»: ${n.d>=0?"+":""}${n.d.toFixed(1)}% (نسبت به Baseline)`)}function s(){o();i(r())}"loading"!==t.readyState?s():e.addEventListener("DOMContentLoaded",s,{once:!0}),t.addEventListener("model:updated",()=>{const e=r();o(),i(e)})}(),function(){function n(){const e=parseFloat(t.getElementById("p-eff")?.value||"0.3"),n=parseFloat(t.getElementById("p-dem")?.value||"0.6"),{key:a,d:o}=Array.from(t.querySelectorAll(".kpi")).map(e=>{const t=e.dataset.kpi||e.querySelector(".kpi-title")?.textContent?.trim(),n=(e.querySelector(".delta-chip")?.textContent||"0%").match(/([+-]?\d+(\.\d+)?)%/);return{key:t,d:n?parseFloat(n[1]):0}}).sort((e,t)=>Math.abs(t.d)-Math.abs(e.d))[0]||{key:null,d:0};if(!a)return"—";const r=o>=0?"افزایش":"کاهش",i="leakage_rate"===a?"نرخ تلفات شبکه":"per_capita_use"===a?"مصرف سرانه":"supply_demand_gap"===a?"شکاف عرضه-تقاضا":a;return`با تنظیم eff=${e.toFixed(2)} و dem=${n.toFixed(2)}، ${i} ${r} ${Math.abs(o).toFixed(1)}٪ داشت.`}function a(){let e=t.getElementById("explain-10s");e||(e=t.createElement("div"),e.id="explain-10s",e.className="explain-10s",(t.querySelector("#hero-kpi .hero-left")||t.getElementById("hero-kpi")||t.body).appendChild(e)),e.textContent=n()}e.__EXPLAIN10__||(e.__EXPLAIN10__=!0,t.addEventListener("model:updated",a),"loading"!==t.readyState?a():e.addEventListener("DOMContentLoaded",a,{once:!0}))}(),e.addEventListener("DOMContentLoaded",function(){!function(){const e=t.querySelector("#cld-toolbar")||t.querySelector('.toolbar, .topbar, [data-toolbar="cld"]')||[...t.querySelectorAll("header, .controls, .panel, .row")].find(e=>/ELK|Poster|تاخیر|تأخیر|Layout|روابط|Loops|weak|strong/i.test(e.textContent||""))||null;if(!e)return;const n=t.getElementById("group-mode"),a=t.getElementById("group-filter"),o=t.getElementById("group-advanced"),r=t.getElementById("group-layout"),i=new Map;function s(e){const n=t.createElement("button");n.type="button",n.className="btn-reset",n.textContent="بازنشانی",n.addEventListener("click",()=>{e.querySelectorAll("input, select").forEach(e=>{const t=i.get(e);null!=t&&("INPUT"===e.tagName&&"checkbox"===e.type?(e.checked=!!t,e.dispatchEvent(new Event("change",{bubbles:!0}))):(e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0}))))})});const a=t.createElement("div");a.className="ac-body",a.appendChild(n),e.parentElement.appendChild(a)}[...e.querySelectorAll('button, select, input[type="range"], input[type="checkbox"], .toggle, .switch')].filter(e=>!/Save|Load|New|Export/i.test(e.innerText||e.value||"")).forEach(e=>{const s=function(e){const n=t.createElement("div");n.className="ctl-chip";const a=[];e.previousElementSibling&&/\?/.test(e.previousElementSibling.textContent||"")&&a.push(e.previousElementSibling),e.nextElementSibling&&/\?/.test(e.nextElementSibling.textContent||"")&&a.push(e.nextElementSibling);const o=function(e){const t=(e.closest("label")?.innerText||e.parentElement?.innerText||"").trim();return/سال|year/i.test(t)?"سال":/درصد|%|leak|weight|rate/i.test(t)?"%":e.dataset?.unit||""}(e),r=function(e){return"INPUT"===e.tagName&&"range"===e.type?{min:e.min??"",max:e.max??"",step:e.step??"",def:e.getAttribute("value")??e.value??""}:null}(e);i.set(e,"INPUT"===e.tagName?e.value:e.value||e.textContent),n.appendChild(e),a.forEach(e=>{e.classList?.add("ctl-help"),n.appendChild(e)});const s=t.createElement("div");if(s.className="meta",o){const e=t.createElement("span");e.className="unit",e.textContent=o,s.appendChild(e)}if(r){const e=t.createElement("span");e.className="rng",e.textContent=`min:${r.min} • max:${r.max} • step:${r.step}`,s.appendChild(t.createTextNode(" ")),s.appendChild(e);const n=t.createElement("span");n.className="def",n.textContent=` • default:${r.def}`,s.appendChild(n)}return(o||r)&&n.appendChild(s),n}(e),c=function(e){const t=(e.innerText||e.value||e.getAttribute("aria-label")||"").trim();return/ELK|Poster|Layout|Auto[-\s]?layout|Grid|Dagre|Cola|Rank/i.test(t)?"layout":/تاخیر|تأخیر|delay|وزن|weight|loops|حلقه|weak|strong|پنهان|نمایش|highlight|threshold/i.test(t)?"filter":"mode"}(e);"layout"===c?r.appendChild(s):"filter"===c?(!function(e){const t=(e.innerText||e.value||e.getAttribute("aria-label")||"").trim();return/سه.?گره|only|debug|hidden|internal|poster test|alpha|beta|cluster.+edges?/i.test(t)}(e)?a:o).appendChild(s):n.appendChild(s)}),s(n),s(a),s(r)}()}),(()=>{const n={version:e.MODEL_VERSION||"v1.0",kpis:{supply_demand_gap:{unit:"%",thresholds:{red:20,amber:10,better:"lower"}},per_capita_use:{unit:"L/day",thresholds:{red:250,amber:200,better:"lower"}},leakage_rate:{unit:"%",thresholds:{red:25,amber:15,better:"lower"}}},sampleScenario:{title:"کاهش تلفات ۳۰→۲۰٪",changes:{leakage_rate:.2}}},a=e=>t.querySelector(e),o=e=>Array.from(t.querySelectorAll(e));function r(n){let a=!1;if(e.ModelBridge&&"function"==typeof ModelBridge.setParam)for(const[e,t]of Object.entries(n))try{ModelBridge.setParam(e,t),a=!0}catch(e){}else for(const[e,o]of Object.entries(n)){const n=t.querySelector(`[data-param="${e}"]`);n&&(n.value=o,n.dispatchEvent(new Event("input",{bubbles:!0})),a=!0)}a&&(e.ModelBridge&&"function"==typeof ModelBridge.rerunModel&&ModelBridge.rerunModel(),t.dispatchEvent(new CustomEvent("scenario:applied")))}function i(){o(".kpi").forEach(t=>{const a=t.dataset.kpi,o=n.kpis[a],r=function(t){if(e.ModelBridge&&"function"==typeof ModelBridge.getKPI)try{return ModelBridge.getKPI(t)}catch(e){}return{supply_demand_gap:12.4,per_capita_use:210,leakage_rate:24.8}[t]}(a);var i;t.querySelector(".val").textContent=null==(i=r)||isNaN(i)?"—":Number(i).toFixed(1),t.querySelector(".unit").textContent=o.unit;const s=t.querySelector(".kpi-rag");s.classList.remove("rag-red","rag-amber","rag-green","rag-neutral"),s.classList.add(function(e,t){return null==e||isNaN(e)||!t?"rag-neutral":"lower"===(t.better||"lower")?e>=t.red?"rag-red":e>=t.amber?"rag-amber":"rag-green":e<=t.red?"rag-red":e<=t.amber?"rag-amber":"rag-green"}(r,o.thresholds))});const t=a("#hero-baseline");t&&(t.textContent=`Baseline ${n.version}`)}let s=null;function c(){s||(s=function(){if(e.ModelBridge&&"function"==typeof ModelBridge.getAllParams)try{return ModelBridge.getAllParams()}catch(e){}const t={};return o("[data-param]").forEach(e=>{t[e.dataset.param]=Number(e.value??e.getAttribute("value"))}),t}()),r(n.sampleScenario.changes)}function l(){s&&r(s)}function d(){a("#btn-run-sample")?.addEventListener("click",c),a("#btn-reset-baseline")?.addEventListener("click",l),i()}t.addEventListener("model:updated",i),o("[data-param]").forEach(e=>e.addEventListener("input",i)),e.whenModelReady?whenModelReady(d):"complete"===t.readyState?d():e.addEventListener("DOMContentLoaded",d)})(),function(){if(e.__READABILITY_BOUND__||e.__CLD_READABILITY_BOUND__)return;e.__READABILITY_BOUND__=e.__CLD_READABILITY_BOUND__=!0,e.onCyReady||(e.onCyReady=function(n){if(e.cy&&"function"==typeof e.cy.on)try{n(e.cy)}catch(e){}else t.addEventListener("cy:ready",t=>{const a=t.detail?.cy||e.cy;if(a)try{n(a)}catch(e){}},{once:!0}),"loading"!==t.readyState?setTimeout(()=>{if(e.cy)try{n(e.cy)}catch(e){}},0):t.addEventListener("DOMContentLoaded",()=>{if(e.cy)try{n(e.cy)}catch(e){}},{once:!0})});const n=e.__cldDebounce||((e,t=70)=>{let n=0;return(...a)=>{clearTimeout(n),n=setTimeout(()=>e(...a),t)}});function a(a){a.scratch("_readability_style_applied")||(a.batch(()=>{a.style().selector("node").style({label:"data(_label)","text-wrap":"wrap","text-max-width":"180px","text-valign":"center","text-halign":"center","min-zoomed-font-size":10,shape:"round-rectangle"}).selector("edge").style({"source-label":"data(_signLabel)","source-text-margin-y":"-6px","font-size":12,"min-zoomed-font-size":8}).selector("edge.delayed").style({"line-style":"dotted"}).update()}),a.scratch("_readability_style_applied",!0));const o="function"==typeof e.measureAndResizeNodes,r=o?null:t.createElement("canvas").getContext("2d");function i(){a.batch(()=>{a.edges().forEach(e=>{const t=e.data("sign")??e.data("polarity")??(Number(e.data("weight"))>=0?1:-1);e.data("_signLabel",t>=0?"+":"–");const n=!!(e.data("delay")||e.data("lag")||Number(e.data("tau"))>0||Number(e.data("delayYears"))>0);e.toggleClass("delayed",n),e.style("width",function(e){const t=Math.abs(Number(e.data("weight")??e.data("w")??0));return 1+3*Math.max(0,Math.min(1,isFinite(t)?t:0))}(e))})})}const s=()=>{a.nodes().forEach(e=>{const t=e.data("label")??e.data("name")??e.data("title")??e.id();e.data("_label")!==t&&e.data("_label",String(t))}),o?e.measureAndResizeNodes(a):r&&a.batch(()=>{a.nodes().forEach(e=>{const t=(e.data("_label")||"").toString(),n=Math.max(12,parseFloat(e.style("font-size"))||12),a=e.style("font-family")||"IRANSans, Tahoma, sans-serif";r.font=`${n}px ${a}`;const o=t.split(/\n|\\n/),i=o.map(e=>r.measureText(e).width),s=Math.max(64,Math.max(...i,0)+32),c=Math.max(28,o.length*(n+6)+16);e.style({width:s,height:c,"font-size":n})})}),i()},c=n(s,70);if(s(),a.on("data add remove position pan zoom layoutstop",c),!t.getElementById("toggle-high-contrast")){const e=t.createElement("button");e.id="toggle-high-contrast",e.type="button",e.className="btn-soft",e.textContent="کنتراست بالا",(t.querySelector("#cld-toolbar")||t.querySelector("#hero-kpi")||t.querySelector("header")||t.body).appendChild(e);let n=!1;e.addEventListener("click",()=>{n=!n,a.batch(()=>{a.style().selector("node").style({"text-outline-width":n?3:1,"text-outline-color":n?"#000":"transparent"}).selector("edge").style({"text-outline-width":n?3:0,"text-outline-color":n?"#000":"transparent"}).update()})})}!function(){const e=a.container&&a.container();if(!e||e.__legend_mounted)return;e.__legend_mounted=!0;const n=t.querySelector(".legend, .cy-legend, [data-legend]"),o=t.createElement("aside");o.className="legend-sticky",o.dir="rtl",o.innerHTML='\n        <h4>راهنما</h4>\n        <div class="row"><span class="swatch pos"></span><span>رابطه مثبت (+)</span></div>\n        <div class="row"><span class="swatch neg"></span><span>رابطه منفی (−)</span></div>\n        <div class="row"><span class="swatch delay"></span><span>تأخیر (dotted)</span></div>\n        <div class="row"><span class="swatch"></span><span>ضخامت ∝ |وزن رابطه|</span></div>\n      ';(e.parentElement||e).insertBefore(o,e),n&&(n.style.display="none")}()}e.graphStore&&"function"==typeof e.graphStore.run?graphStore.run(a):onCyReady(a)}(),function(){if(e.__FIX_HINTS_BOUND__)return;e.__FIX_HINTS_BOUND__=!0;const n=".toolbar.filters",a=/^(INPUT|SELECT|BUTTON|OUTPUT|LABEL)$/,o=(e,n=t)=>n.querySelector(e);function r(e){if(e.__fixed_hint__)return;if(!e.closest(n))return;const o=function(e){const n=e.dataset.for;if(n){const e=t.getElementById(n);if(e)return e}const o=e.closest("label.ctrl");if(o)return o;let r=e.previousElementSibling;for(;r&&!a.test(r.tagName);)r=r.previousElementSibling;if(r)return r;const i=e.parentElement;if(i){const e=Array.from(i.children).filter(e=>a.test(e.tagName));if(e.length)return e[e.length-1]}return null}(e);if(!o)return void(e.__fixed_hint__=!0);if("LABEL"===o.tagName&&o.classList.contains("ctrl"))return o.appendChild(e),void(e.__fixed_hint__=!0);let r=t.createElement("span");r.className="hint-wrap",o.parentElement.classList.contains("hint-wrap")?r=o.parentElement:(o.replaceWith(r),r.appendChild(o)),r.appendChild(e),e.__fixed_hint__=!0}function i(){const e=o(n);e&&((e,n=t)=>Array.from(n.querySelectorAll(e)))(".hint",e).forEach(r)}"complete"===t.readyState||"interactive"===t.readyState?i():e.addEventListener("DOMContentLoaded",i,{once:!0});const s=new MutationObserver(e=>{let t=!1;for(const n of e){if(n.addedNodes&&n.addedNodes.length){t=!0;break}if("attributes"===n.type&&n.target.classList?.contains("hint")){t=!0;break}}t&&i()});e.addEventListener("load",()=>{const e=o(n);e&&s.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["data-for","class"]})}),t.addEventListener("model:updated",i)}(),function(){if(e.__GHOST_DELTA__)return;e.__GHOST_DELTA__=!0;const n=(e,n=t)=>n.querySelector(e),a=(e,n=t)=>Array.from(n.querySelectorAll(e));function o(){const e=parseFloat(n("#p-eff")?.value||"0.3"),t=parseFloat(n("#p-dem")?.value||"0.6"),a={};return a.per_capita_use=100*(t-.6),a.leakage_rate=60*(.3-e),a.supply_demand_gap=40*(t-e),a}function r(e){a(".kpi").forEach(n=>{const a=n.dataset.kpi;if(!a||null==e[a])return;let o=n.querySelector(".ghost");o||(o=t.createElement("span"),o.className="ghost",o.style.cssText="position:absolute;bottom:6px;inset-inline-end:6px;font-size:11px;opacity:.7",n.appendChild(o));const r=e[a],i=(r>=0?"+":"")+r.toFixed(1)+"%~";o.textContent=i})}function i(){["p-eff","p-dem"].forEach(e=>{const n=t.getElementById(e);n&&["input","change"].forEach(e=>n.addEventListener(e,()=>r(o())))})}"loading"!==t.readyState?(i(),r(o())):e.addEventListener("DOMContentLoaded",()=>{i(),r(o())},{once:!0}),t.addEventListener("model:updated",()=>{a(".kpi .ghost").forEach(e=>e.remove())})}(),e.__CLD_READY__=e.__CLD_READY__||!1,e.onCyReady=e.onCyReady||function(n){if(e.cy&&"function"==typeof e.cy.on)try{n(e.cy)}catch(e){}else e.__CLD_READY__||(e.__CLD_READY__=!0,t.addEventListener("cy:ready",t=>{const a=t.detail?.cy||e.cy;if(a&&"function"==typeof n)try{n(a)}catch(t){}},{once:!0}),e.whenModelReady?e.whenModelReady(()=>{if(e.cy&&"function"==typeof n)try{n(e.cy)}catch(e){}}):t.addEventListener("DOMContentLoaded",()=>{if(e.cy&&"function"==typeof n)try{n(e.cy)}catch(e){}},{once:!0}))},e.__cldDebounce=e.__cldDebounce||function(e,t=50){let n=0;return(...a)=>{clearTimeout(n),n=setTimeout(()=>e(...a),t)}},e.__cldSafeFit=e.__cldSafeFit||function(e){if(e&&0!==e.elements().length)try{e.fit(e.elements(),40)}catch(e){}},function(){const n=e.exprEval&&e.exprEval.Parser||function(){this.parse=function(){return{evaluate:function(){return 0},variables:function(){return[]}}}};var a=!1,o=!1,r=[];function i(e){if(a)try{e()}catch(e){console.error(e)}else r.push(e)}function s(){a=!0;for(var e=0;e<r.length;e++)try{r[e]()}catch(e){console.error(e)}r=[]}function c(){const n=.01*e.innerHeight;t.documentElement.style.setProperty("--vh",`${n}px`)}let l,d;e.whenModelReady=i,c(),e.addEventListener("resize",c),e.addEventListener("orientationchange",()=>{setTimeout(c,100)});let u={};const p="cld-scenarios";function f(){try{return JSON.parse(localStorage.getItem(p))||{}}catch(e){return{}}}function h(e){localStorage.setItem(p,JSON.stringify(e))}function y(e){const t=new n;l={nodes:{},edges:[],order:[],initials:{}},(e.nodes||[]).forEach(e=>{const n={...e,deps:[]};if(e.expr)try{n.fn=t.parse(e.expr)}catch(t){console.error("node parse",e.id,t)}"init"===e.type&&(n.value=n.fn?n.fn.evaluate({}):parseFloat(e.expr)||0,l.initials[e.id]=n.value),void 0!==e.init&&(l.initials[e.id]=e.init),l.nodes[e.id]=n}),(e.edges||[]).forEach(e=>{const n={...e};if(e.expr)try{n.fn=t.parse(e.expr)}catch(t){console.error("edge parse",e.source,e.target,t)}l.edges.push(n)}),Object.values(l.nodes).forEach(e=>{"expr"===e.type&&e.fn&&(e.deps=e.fn.variables().filter(e=>l.nodes[e]))});const a={};Object.keys(l.nodes).forEach(e=>a[e]=0),Object.values(l.nodes).forEach(e=>e.deps.forEach(t=>a[e.id]++));const o=[];Object.keys(a).forEach(e=>{0===a[e]&&o.push(e)});const r=[];for(;o.length;){const e=o.shift();r.push(e),Object.values(l.nodes).forEach(t=>{t.deps.includes(e)&&(a[t.id]--,0===a[t.id]&&o.push(t.id))})}return Object.keys(l.nodes).forEach(e=>{r.includes(e)||r.push(e)}),l.order=r,l}function m(e,t){const n=l&&l.initials?l.initials:{},a=e[t-1]||{},o={};let r=0,i=!0;for(;i&&r<8;){i=!1;for(const r of l.order){const s=l.nodes[r];if("init"===s.type){o[r]=l.initials[r];continue}const c=Object.assign({},u,a,o,{delay:function(a,o){const r=t-(o="number"==typeof o?o:1);if(r<0)return n[a]||0;const i=e[r];return i&&null!=i[a]?i[a]:n[a]||0}});let d=0;try{d=s.fn?s.fn.evaluate(c):0}catch(e){console.error("eval",r,e)}(void 0===o[r]||Math.abs(o[r]-d)>1e-6)&&(o[r]=d,i=!0)}r++}return o}function g(e){if(!l||!l.initials)throw new Error("model not ready");u=e=e||{};const t=e.years||30,n=l.initials||{},a=[Object.assign({},n)];for(var o=1;o<=t;o++)a[o]=m(a,o);return{years:Array.from({length:t+1},function(e,t){return t}),series:a.map(function(e){return e.gw_stock})}}let v,_,E;function b(){try{const n=t.getElementById("sim-chart");if(!n)return console.warn("sim-chart not found");if(!e.Chart)return console.warn("Chart.js not loaded");const a=n.getContext("2d");e.__wesh_sim_chart||(Chart.defaults.font.family="Vazirmatn, sans-serif",e.__wesh_sim_chart=new Chart(a,{type:"line",data:{labels:[],datasets:[{label:"پایه",data:[],borderWidth:2,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1}})),_=e.__wesh_sim_chart,o=!0,i(L)}catch(e){console.error("initSimChart failed",e)}}function L(){if(e.__wesh_sim_chart)try{if(l&&l.initials){var t=g({eff:0,dem:0,delay:0,years:30}),n=t.years||(t.baseline?t.baseline.map(function(e,t){return t}):[]);E={years:n,baseline:t.baseline||t.series||[]},C(E)}else e.__wesh_sim_chart.data.labels.length||(E={years:Array.from({length:30},function(e,t){return t}),baseline:Array.from({length:30},function(){return 100})},C(E))}catch(e){console.error("baseline init failed",e)}}function C(t){if(!e.__wesh_sim_chart||!t)return;const n=t.years||Array.from({length:t.baseline?t.baseline.length:t.series?t.series.length:0},(e,t)=>t);e.__wesh_sim_chart.data.labels=n;const a=[{label:"پایه",data:t.baseline||t.series||[],borderWidth:2,borderColor:"#0ea5e9",backgroundColor:"rgba(14,165,233,0.1)",fill:!1}];t.scenario&&a.push({label:"سناریو",data:t.scenario,borderWidth:2,borderColor:"rgb(220,38,38)",backgroundColor:"rgba(220,38,38,0.1)",fill:!1}),e.__wesh_sim_chart.data.datasets=a,e.__wesh_sim_chart.update()}function x(){if(!E)return;C(E);const e=t.getElementById("p-eff"),n=t.getElementById("p-dem"),a=t.getElementById("p-delay");e&&(e.value=0,e.dispatchEvent(new Event("input"))),n&&(n.value=0,n.dispatchEvent(new Event("input"))),a&&(a.value=0,a.dispatchEvent(new Event("input")))}e.measureAndResizeNodes=function(n,a={}){const o=a.fontSize||15,r="number"==typeof a.padding?a.padding:18,i=a.maxWidth||a.maxTextWidth||260,s=a.minWidth||100,c=a.minHeight||48,l=n.container(),d=e.getComputedStyle(l),u=d&&d.fontFamily?d.fontFamily:"sans-serif",p=function(e){const n=t.createElement("canvas").getContext("2d");return{setFont:function(t){n.font=e+"px "+t},measure:function(e){return n&&"function"==typeof n.measureText?n.measureText(e).width:0},wrapLines:function(e,t){if(!e)return[""];const n=e.split(/\s+/),a=[];let o=n[0]||"";for(let e=1;e<n.length;e++){const r=n[e],i=o+" "+r;this.measure(i)<=t?o=i:(a.push(o),o=r)}return a.push(o),a}}}(o);p.setFont(u),n.batch(()=>{n.nodes().forEach(e=>{if(e.isParent&&e.isParent())return;const t=(void 0!==e.data("label")?String(e.data("label")):e.id()||"").replace(/\s+/g," ").trim(),n=p.wrapLines(t,i);let a=0;n.forEach(e=>{const t=p.measure(e);t>a&&(a=t)});const l=Math.ceil(1.3*o),d=n.length*l,u=Math.max(s,Math.ceil(a+2*r)),f=Math.max(c,Math.ceil(d+2*r)),h=n.join("\n");e.data("label",h),e.style({width:u+"px",height:f+"px","text-valign":"center","text-halign":"center"})})})},t.addEventListener("DOMContentLoaded",b),t.fonts&&t.fonts.ready&&t.fonts.ready.then(b).catch(function(){b()}),e.loadModelFromUrl=function(n){fetch(n,{cache:"no-store"}).then(function(e){return e.json()}).then(function(a){d=a,y(a),s(),o&&L();var r=e.cy;if(r&&a){var i=t.getElementById("f-group");i&&(i.innerHTML='<option value="">همه گروه‌ها</option>',(a.groups||[]).forEach(function(e){var n=t.createElement("option");n.value=e.id,n.textContent=e.id,i.appendChild(n)})),r.startBatch(),r.elements().remove(),(a.nodes||[]).forEach(function(e){r.add({data:{id:e.id,label:e.label,group:e.group,unit:e.unit,desc:e.desc}})}),(a.groups||[]).forEach(function(e){r.getElementById(e.id).nonempty||r.add({data:{id:e.id,label:e.id},classes:"compound"}),r.nodes().filter('[group = "'+e.id+'"]').move({parent:e.id}).style("background-color",e.color);var t=r.getElementById(e.id);t&&t.style({"background-color":e.color,"border-color":e.color})}),(a.edges||[]).forEach(function(e){r.add({group:"edges",data:{id:e.id||e.source+"__"+e.target+"__"+(e.sign||""),source:e.source,target:e.target,sign:e.sign,label:e.label||("-"===e.sign?"−":"+"),weight:"number"==typeof e.weight?e.weight:void 0,delayYears:"number"==typeof e.delayYears?e.delayYears:0}}).addClass("-"===e.sign?"neg":"pos")}),r.endBatch(),function(e){var t={};e.nodes().forEach(function(e){var n=e.data("group")||"_";(t[n]=t[n]||[]).push(e)});var n=Object.keys(t),a=Math.ceil(Math.sqrt(n.length)),o=0;n.forEach(function(e){var n=o%a*800+200,r=600*Math.floor(o/a)+200;t[e].forEach(function(e,t){var a=t%3,o=Math.floor(t/3),i=n+260*a+(20*Math.random()-10),s=r+220*o+(20*Math.random()-10);e.position({x:i,y:s})}),o++})}(r);var c=(t.getElementById("layout")||{}).value||"elk",l=(t.getElementById("layout-dir")||{}).value||"LR";e.runLayout&&e.runLayout(c,l),e.populateLoops&&e.populateLoops(r,a.loops||[]);try{localStorage.setItem("waterCLD.activeModel",n)}catch(e){}}})},t.addEventListener("DOMContentLoaded",async function(){const a=t.getElementById("cy");if(!a)return void console.warn("cy container not found");if(void 0===e.cytoscape)return void console.warn("cytoscape not loaded");e.tippy&&tippy(".hint",{allowHTML:!0,theme:"light",delay:[80,0],placement:"bottom",maxWidth:320,interactive:!0});const r=getComputedStyle(t.documentElement),c=r.getPropertyValue("--pos").trim()||"#16a34a",l=r.getPropertyValue("--neg").trim()||"#dc2626",u=r.getPropertyValue("--accent").trim()||"#58a79a",p=r.getPropertyValue("--line").trim()||"#2f6158",m=r.getPropertyValue("--text").trim()||"#e6f1ef";v=cytoscape({container:a,elements:[],style:[{selector:"node",style:{"background-color":"#f8faf9","border-width":2}},{selector:"node[label][!isGroup]",style:{label:"data(label)","font-family":"Vazirmatn, sans-serif","text-wrap":"wrap","text-max-width":260,"font-size":15,"font-weight":500,color:"#0a0f0e","text-valign":"center","text-halign":"center","text-margin-y":0,"text-outline-width":0,"background-color":"#eaf3f1",shape:"round-rectangle",padding:"12px 18px","border-width":3,"border-color":"#ffffff","min-zoomed-font-size":8}},{selector:"node.compound",style:{shape:"round-rectangle","background-color":"#ffffff","background-opacity":.12,"border-color":"#2b3c39","border-width":1.5,label:"data(label)","text-valign":"top","text-halign":"center","font-size":12,color:"#cfe7e2",padding:24,"font-family":"Vazirmatn, sans-serif"}},{selector:"edge",style:{"curve-style":"bezier",width:e=>2+(e.data("weight")||0),"line-style":e=>e.data("delayYears")>0?"dashed":"solid","line-dash-pattern":e=>e.data("delayYears")>0?[8,6]:[0],"target-arrow-shape":"triangle","arrow-scale":1.2,"line-color":p,"target-arrow-color":p,"source-arrow-color":p,label:"data(label)","text-rotation":"autorotate","text-background-color":"rgba(0,0,0,0.35)","text-background-opacity":1,"text-background-padding":1,"text-wrap":"wrap","text-max-width":100,"font-family":"Vazirmatn, sans-serif","font-size":12,color:m}},{selector:"edge.pos",style:{"line-color":c,"target-arrow-color":c,"source-arrow-color":c}},{selector:"edge.neg",style:{"line-color":l,"target-arrow-color":l,"source-arrow-color":l}},{selector:".hidden",style:{display:"none"}},{selector:".faded",style:{opacity:.1}},{selector:".highlighted",style:{"border-color":"#facc15","border-width":3}},{selector:".highlight",style:{"border-color":u,"border-width":3}},{selector:"edge.highlight",style:{"line-color":u,"target-arrow-color":u,"source-arrow-color":u,width:4}}],layout:{name:"grid"}}),e.cy=v,function(){function e(){var e=v.zoom();v.batch(function(){v.edges().forEach(function(t){t.style("label",e>=1?t.data("label"):"")})})}v.on("zoom",e),e()}(),v.on("mouseover","node",function(e){var t=e.target.closedNeighborhood();v.batch(function(){v.elements().difference(t).addClass("faded"),t.removeClass("faded")})}),v.on("mouseout","node",function(){v.elements().removeClass("faded")}),v.style().selector(".faded").style({opacity:.15}).update(),onCyReady(n=>{n.style().selector("node").style({width:"label",height:"label","text-wrap":"wrap","text-max-width":240,padding:"16px","font-size":15,"font-weight":600,color:"#0a0f0e","background-color":"#f8fafc","border-color":"#94a3b8","border-width":1,shape:"round-rectangle"}).selector("node.compound").style({width:"auto",height:"auto"}).selector("edge").style({"curve-style":"bezier",width:"mapData(weight, 0, 1.2, 2, 6)","target-arrow-shape":"triangle","line-cap":"round",label:"data(label)","text-rotation":"autorotate","font-size":11,"text-background-color":"rgba(11,18,32,.65)","text-background-opacity":1,"text-background-shape":"roundrectangle","text-background-padding":3,color:"#e6f1ff"}).selector('edge[sign = "+"]').style({"line-color":"#16a34a","target-arrow-color":"#16a34a"}).selector('edge[sign = "-"]').style({"line-color":"#dc2626","target-arrow-color":"#dc2626"}).selector("edge[delayYears > 0]").style({"line-style":"dashed","line-dash-pattern":[8,6]}).update(),n.on("layoutstop",function(){e.measureAndResizeNodes&&e.measureAndResizeNodes(n,{maxWidth:240,padding:16})}),t.fonts&&t.fonts.ready&&t.fonts.ready.then(function(){e.measureAndResizeNodes&&e.measureAndResizeNodes(n,{maxWidth:240,padding:16})})}),v.on("ready",()=>setTimeout(()=>e.__cldSafeFit(v),0)),e.addEventListener("resize",()=>requestAnimationFrame(()=>e.__cldSafeFit(v))),e.addEventListener("orientationchange",()=>setTimeout(()=>e.__cldSafeFit(v),150)),t.fonts&&t.fonts.ready&&t.fonts.ready.then(()=>setTimeout(()=>e.__cldSafeFit(v),60)),function(){function n(e){return null==e?"":String(e).replace(/[&<>"]/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[e]))}function a(e,t){return function(){const n=e.renderedBoundingBox({includeLabels:!0}),a=t.container().getBoundingClientRect(),o=Math.max(10,n.w||n.x2-n.x1),r=Math.max(10,n.h||n.y2-n.y1),i=a.left+(n.x1||0),s=a.top+(n.y1||0);return{width:o,height:r,top:s,left:i,right:i+o,bottom:s+r}}}function o(e){const a=e.data()||{},o=t.createElement("div");o.dir="rtl",o.style.whiteSpace="normal",o.style.maxWidth="260px";const r=[];if(e.isNode&&e.isNode()){r.push(`<div style="font-weight:600;margin-bottom:4px">${n(a.label||a.id||"")}</div>`),a.desc&&r.push(`<div>${n(a.desc)}</div>`);const e=[];a.unit&&e.push(`واحد: ${n(a.unit)}`),a.group&&e.push(`گروه: ${n(a.group)}`),e.length&&r.push(`<div style="opacity:.8;margin-top:4px">${e.join(" • ")}</div>`)}else{r.push(`<div style="font-weight:600;margin-bottom:4px">${n(a.label||"")}</div>`);const e=[];a.sign&&e.push("قطبیت: "+("+"===a.sign?"مثبت (+)":"منفی (−)")),"number"==typeof a.weight&&e.push(`وزن: ${a.weight}`),"number"==typeof a.delayYears&&e.push(`تأخیر: ${a.delayYears} سال`),e.length&&r.push(`<div>${e.join(" • ")}</div>`)}return o.innerHTML=r.join(""),o}function r(e){e.on("mouseover","node, edge",function(n){const r=n.target;if(r.scratch("_tippy"))return;const i=function(e,n){return tippy(t.body,{trigger:"manual",appendTo:()=>n.container(),allowHTML:!0,interactive:!1,arrow:!0,placement:"top",getReferenceClientRect:a(e,n),content:o(e),theme:"light",hideOnClick:!1})}(r,e);r.scratch("_tippy",i),i.show()}),e.on("mouseout tap","node, edge",function(e){const t=e.target.scratch("_tippy");t&&(t.destroy(),e.target.scratch("_tippy",null))});const n=()=>{e.$("node, edge").forEach(t=>{const n=t.scratch("_tippy");n&&(n.setProps({getReferenceClientRect:a(t,e)}),n.popperInstance&&n.popperInstance.update&&n.popperInstance.update())})};e.on("pan zoom drag position",n),e.on("layoutstop",n),e.on("remove","node, edge",function(e){const t=e.target.scratch("_tippy");t&&t.destroy()})}e.tippy&&onCyReady(e=>{r(e)})}(),onCyReady(e=>{e.on("dbltap","node",e=>{e.target.locked()?e.target.unlock().removeClass("highlight"):e.target.lock().addClass("highlight")})});const b=t.getElementById("layout"),k=t.getElementById("layout-preset");k&&k.addEventListener("change",()=>{const t=k.value;if(t){if(e.getLayoutPreset){const n=e.getLayoutPreset(t);if(n)try{v.layout(n).run()}catch(e){console.error("layout preset",e)}}}else b&&runLayout(b.value)});const S=t.getElementById("f-pos"),w=t.getElementById("f-neg"),N=t.getElementById("f-group"),A=t.getElementById("f-delay"),B=t.getElementById("q"),I=t.getElementById("loops-list"),M=t.getElementById("btn-loops"),D=t.getElementById("panel-loops"),T=t.getElementById("flt-weight-min"),O=t.getElementById("flt-delay-max"),R=t.getElementById("flt-weight-min-val"),$=t.getElementById("flt-delay-max-val");function P(){v.elements().removeClass("hidden");const t=!(S&&S.classList.contains("off")),n=!(w&&w.classList.contains("off")),a=N?N.value:"",o=!!A&&A.checked;v.edges().forEach(e=>{const r="+"===e.data("sign")?t:n,i=!a||e.source().data("parent")===a&&e.target().data("parent")===a,s=!o||e.data("delayYears")>0;r&&i&&s||e.addClass("hidden")}),v.nodes().forEach(e=>{a&&e.data("parent")!==a&&e.id()!==a&&e.addClass("hidden")}),e.__cldSafeFit(v)}function q(e,t){e&&t&&(t.textContent=String(e.value),e.addEventListener("input",()=>{t.textContent=String(e.value)}))}function F(){v.edges().removeClass("hidden");const t=T?Number(T.value):0,n=O?Number(O.value):0;v.edges().forEach(e=>{(e.data("weight")<t||e.data("delayYears")>n)&&e.addClass("hidden")}),e.__cldSafeFit(v)}q(T,R),q(O,$),T&&T.addEventListener("input",F,{passive:!0}),O&&O.addEventListener("input",F,{passive:!0}),S&&S.addEventListener("click",()=>{S.classList.toggle("off"),P()}),w&&w.addEventListener("click",()=>{w.classList.toggle("off"),P()}),N&&N.addEventListener("change",P),A&&A.addEventListener("change",P),P(),F(),B&&B.addEventListener("input",()=>{v.elements().removeClass("faded"),v.nodes().removeClass("highlighted");const e=B.value.trim();if(e){let t;try{t=new RegExp(e,"i")}catch(e){return}v.nodes().addClass("faded"),v.edges().addClass("faded");const n=v.nodes().filter(e=>t.test(e.data("label")));n.removeClass("faded").addClass("highlighted"),n.connectedEdges().removeClass("faded")}}),M&&M.addEventListener("click",()=>{!function(){if(!I||!e.cydetectLoops)return;I.innerHTML="";(e.cydetectLoops(v)||[]).forEach(e=>{const n=t.createElement("li"),a=(e.nodeIds||[]).map(e=>v.getElementById(e).data("label")||e),o=(e.edgeIds||[]).filter(e=>"-"===v.getElementById(e).data("sign")).length%2==0?"+":"-";n.textContent=`${o}: ${a.join(" → ")}`,n.style.cursor="pointer",n.addEventListener("click",()=>{v.elements().removeClass("highlight");const t=v.collection();(e.nodeIds||[]).forEach(e=>{const n=v.getElementById(e);n.addClass("highlight"),t.merge(n)}),(e.edgeIds||[]).forEach(e=>{const n=v.getElementById(e);n.addClass("highlight"),t.merge(n)}),v.fit(t,50)}),I.appendChild(n)})}(),D&&(D.open=!0)});const U=t.getElementById("import-json");U&&U.addEventListener("change",e=>{const n=e.target.files[0];if(!n)return;const a=new FileReader;a.onload=e=>{try{const n=JSON.parse(e.target.result),a=n.groups||[];groupSelect&&(groupSelect.innerHTML='<option value="">همه گروه‌ها</option>',a.forEach(e=>{const n=t.createElement("option");n.value=e.id,n.textContent=e.id,groupSelect.appendChild(n)}));const o=[];a.forEach(e=>o.push({data:{id:e.id,color:e.color,isGroup:!0},classes:"compound group"})),(n.nodes||[]).forEach(e=>o.push({data:{id:e.id,label:e.label,parent:e.group,desc:e.desc,unit:e.unit}})),(n.edges||[]).forEach((e,t)=>o.push({data:{id:`e${t}`,source:e.source,target:e.target,label:e.label,sign:e.sign,weight:e.weight||0,delayYears:e.delayYears||0},classes:"-"===e.sign?"neg":"pos"})),v.elements().remove(),v.add(o),runLayout("elk"),updateSignFilter()}catch(e){console.error("Import JSON failed",e)}},a.readAsText(n)});const j=t.getElementById("legend");if(j){const e=['<span class="badge pos"><i class="dot" style="background:var(--pos)"></i>مثبت</span>','<span class="badge neg"><i class="dot" style="background:var(--neg)"></i>منفی</span>','<span class="badge dashed"><i class="dot" style="border:2px dashed #cbd5e1"></i>تاخیردار/غیرمستقیم</span>'];groups.forEach(t=>e.push(`<span class="badge" style="border-color:${t.color}"><i class="dot" style="background:${t.color}"></i>${t.id}</span>`)),j.innerHTML=e.join("")}const H=t.getElementById("p-eff"),Y=t.getElementById("p-dem"),z=t.getElementById("p-delay"),W=t.getElementById("btn-run"),V=t.getElementById("btn-reset"),J=t.getElementById("btn-export-csv"),G=t.getElementById("sc-new"),K=t.getElementById("sc-save"),X=t.getElementById("sc-load"),Q=t.getElementById("sc-delete"),Z=t.getElementById("sc-table"),ee=t.getElementById("sens-param"),te=t.getElementById("sens-min"),ne=t.getElementById("sens-max"),ae=t.getElementById("sens-step"),oe=t.getElementById("sens-run"),re=t.getElementById("sens-progress");let ie=null,se=null;const ce=new Worker("/assets/sim-worker.js");ce.postMessage({cmd:"init"});const le=t.getElementById("val-eff"),de=t.getElementById("val-dem"),ue=t.getElementById("val-delay");function pe(e,t){e&&t&&(t.textContent=e.value,e.addEventListener("input",()=>{t.textContent=e.value}))}pe(H,le),pe(Y,de),pe(z,ue);const fe=Z?Z.querySelector("tbody"):null;function he(){if(!fe)return;fe.innerHTML="";const e=f();Object.entries(e).forEach(([e,n])=>{const a=t.createElement("tr");a.innerHTML=`<td>${e}</td><td>${n.eff}</td><td>${n.dem}</td><td>${n.delay}</td>`,a.addEventListener("click",()=>{ie=e,Array.from(fe.children).forEach(e=>e.classList.remove("selected")),a.classList.add("selected")}),fe.appendChild(a)})}he(),G&&G.addEventListener("click",()=>{ie=null,x(),fe&&Array.from(fe.children).forEach(e=>e.classList.remove("selected"))}),K&&K.addEventListener("click",()=>{const e=prompt("Scenario name",ie||"");if(!e)return;const t=f();t[e]={eff:parseFloat(H.value),dem:parseFloat(Y.value),delay:parseInt(z.value)},h(t),ie=e,he()}),X&&X.addEventListener("click",()=>{const e=f();if(!ie||!e[ie])return;const t=e[ie];H.value=t.eff,Y.value=t.dem,z.value=t.delay,H.dispatchEvent(new Event("input")),Y.dispatchEvent(new Event("input")),z.dispatchEvent(new Event("input")),W.click()}),Q&&Q.addEventListener("click",()=>{const e=f();ie&&e[ie]&&(delete e[ie],h(e),ie=null,he())}),J&&J.addEventListener("click",()=>{if(!_)return;const e=_.data.labels||[],n=_.data.datasets||[];let a="year,baseline,scenario\n";for(let t=0;t<e.length;t++){const o=[e[t]];o.push(n[0]&&n[0].data?n[0].data[t]:""),o.push(n[1]&&n[1].data?n[1].data[t]:""),a+=o.join(",")+"\n"}const o=new Blob([a],{type:"text/csv"}),r=URL.createObjectURL(o),i=t.createElement("a");i.href=r,i.download="results.csv",i.click(),URL.revokeObjectURL(r)}),ce.onmessage=e=>{if("progress"===e.data.type)re&&(re.textContent=Math.round(100*e.data.value)+"%");else if("complete"===e.data.type){re&&(re.textContent="");const{years:t,p10:n,p50:a,p90:o}=e.data;for(;_.data.datasets.length>1;)_.data.datasets.pop();_.data.labels=t,_.data.datasets.push({label:"p90",data:o,borderColor:"rgba(0,0,0,0)",fill:!1}),_.data.datasets.push({label:"p10",data:n,borderColor:"rgba(0,0,0,0)",backgroundColor:"rgba(99,102,241,0.2)",fill:"-1"}),_.data.datasets.push({label:"p50",data:a,borderColor:"#f97316",backgroundColor:"rgba(249,115,22,0.1)",fill:!1}),_.update(),se={years:t,p10:n,p50:a,p90:o}}},oe&&oe.addEventListener("click",e=>{e.preventDefault();const t=ee.value,n={min:parseFloat(te.value),max:parseFloat(ne.value),step:parseFloat(ae.value)},a={eff:parseFloat(H.value),dem:parseFloat(Y.value),delay:parseInt(z.value)};re&&(re.textContent="0%"),ce.postMessage({cmd:"runBatch",param:t,range:n,base:a})});const ye=t.getElementById("tab-param"),me=t.getElementById("tab-formula"),ge=t.getElementById("panel-param"),ve=t.getElementById("panel-formula");ye&&me&&ge&&ve&&(ye.addEventListener("click",()=>{ye.classList.add("active"),me.classList.remove("active"),ge.style.display="block",ve.style.display="none"}),me.addEventListener("click",()=>{me.classList.add("active"),ye.classList.remove("active"),ge.style.display="none",ve.style.display="block"}));const _e=t.getElementById("formula-node"),Ee=t.getElementById("formula-expr"),be=t.getElementById("formula-msg");_e&&Ee&&((d.nodes||[]).forEach(e=>{const n=t.createElement("option");n.value=e.id,n.textContent=e.label||e.id,_e.appendChild(n)}),_e.addEventListener("change",()=>{const e=d.nodes.find(e=>e.id===_e.value);Ee.value=e&&e.expr?e.expr:"",be&&(be.textContent="")}),_e.dispatchEvent(new Event("change")));const Le=t.getElementById("btn-validate");Le&&Le.addEventListener("click",()=>{try{(new n).parse(Ee.value),be&&(be.textContent="✅")}catch(e){be&&(be.textContent=e.message)}});const Ce=t.getElementById("btn-save");Ce&&Ce.addEventListener("click",function(){try{(new n).parse(Ee.value);var e=d.nodes.find(function(e){return e.id===_e.value});e&&(e.expr=Ee.value),y(d),s(),o&&L(),i(function(){try{var e=g({eff:0,dem:0,delay:0,years:30});E={years:e.years,baseline:e.series},C(E),be&&(be.textContent="Saved")}catch(e){be&&(be.textContent=e.message)}})}catch(e){be&&(be.textContent=e.message)}}),W&&W.addEventListener("click",function(){i(function(){try{var t=g({eff:parseFloat(H.value),dem:parseFloat(Y.value),delay:parseInt(z.value,10),years:E&&E.years?E.years.length-1:30});C({years:t.years,baseline:E?E.baseline:[],scenario:t.series}),e.__wesh_sim_chart&&e.__wesh_sim_chart.update()}catch(e){console.error("simulate failed",e)}})}),function(){var n="waterCLD.ui.v1";function a(){try{return JSON.parse(localStorage.getItem(n)||"{}")}catch(e){return{}}}function o(e){var t=a();for(var o in e)t[o]=e[o];localStorage.setItem(n,JSON.stringify(t))}function r(){var n=t.getElementById("layout");if(!n)return null;var a=t.getElementById("layout-dir");if(a)return a;var r=t.createElement("select");r.id="layout-dir",r.setAttribute("aria-label","جهت چیدمان");var i=t.createElement("option");i.value="LR",i.textContent="چپ→راست";var s=t.createElement("option");return s.value="TB",s.textContent="بالا→پایین",r.appendChild(i),r.appendChild(s),n.insertAdjacentElement("afterend",r),r.addEventListener("change",function(){var n=(t.getElementById("layout")||{}).value||"elk";o({dir:r.value,layout:n}),e.runLayout&&e.runLayout(n,r.value)}),n.addEventListener("change",function(){var a=n.value,r=(t.getElementById("layout-dir")||{}).value||"LR";o({dir:r,layout:a}),e.runLayout&&e.runLayout(a,r)}),r}function i(){var e=a(),n=t.getElementById("layout"),i=t.getElementById("layout-dir")||r(),s=t.getElementById("flt-weight-min"),c=t.getElementById("flt-delay-max"),l=t.getElementById("q"),d=t.getElementById("f-group"),u=t.querySelectorAll("input[type=checkbox].pos"),p=t.querySelectorAll("input[type=checkbox].neg"),f=t.getElementById("f-pos"),h=t.getElementById("f-neg");function y(){o({flt:{weightMin:s?Number(s.value):void 0,delayMax:c?Number(c.value):void 0,pos:u.length?u[0].checked:!(f&&f.classList.contains("off")),neg:p.length?p[0].checked:!(h&&h.classList.contains("off")),group:d?d.value:""}})}e.layout&&n&&(n.value=e.layout),e.dir&&i&&(i.value=e.dir),e.flt&&(s&&void 0!==e.flt.weightMin&&(s.value=e.flt.weightMin),c&&void 0!==e.flt.delayMax&&(c.value=e.flt.delayMax),"boolean"==typeof e.flt.pos&&(u.length&&u.forEach(function(t){t.checked=e.flt.pos}),f&&f.classList.toggle("off",!e.flt.pos)),"boolean"==typeof e.flt.neg&&(p.length&&p.forEach(function(t){t.checked=e.flt.neg}),h&&h.classList.toggle("off",!e.flt.neg)),d&&void 0!==e.flt.group&&(d.value=e.flt.group),(f||h)&&P()),l&&"string"==typeof e.q&&(l.value=e.q),["change","input"].forEach(function(e){s&&s.dispatchEvent(new Event(e)),c&&c.dispatchEvent(new Event(e)),l&&l.dispatchEvent(new Event(e)),d&&d.dispatchEvent(new Event(e)),n&&n.dispatchEvent(new Event("change")),i&&i.dispatchEvent(new Event("change")),u.forEach(function(e){e.dispatchEvent(new Event("change"))}),p.forEach(function(e){e.dispatchEvent(new Event("change"))})}),s&&s.addEventListener("input",y),c&&c.addEventListener("input",y),u.forEach(function(e){e.addEventListener("change",y)}),p.forEach(function(e){e.addEventListener("change",y)}),f&&f.addEventListener("click",y),h&&h.addEventListener("click",y),d&&d.addEventListener("change",y),l&&l.addEventListener("input",function(){o({q:l.value})}),n&&n.addEventListener("change",function(){o({layout:n.value})}),i&&i.addEventListener("change",function(){o({dir:i.value})}),onCyReady(e=>{var t;function n(){var n=e.zoom(),a=e.pan();o({zoom:n,pan:{x:a.x,y:a.y}}),t=null}e.on("zoom pan",function(){t||(t=setTimeout(n,200))})})}!function(){e.runLayout;e.runLayout=function(n,a){var o=e.cy;if(o){var r;if(n=(n||"elk").toLowerCase(),a=a||(t.getElementById("layout-dir")?t.getElementById("layout-dir").value:"LR"),"elk"===n)r={name:"elk",nodeDimensionsIncludeLabels:!0,fit:!1,animate:"end",animationDuration:300,elk:{algorithm:"layered","elk.direction":"TB"===a?"DOWN":"RIGHT","elk.layered.spacing.nodeNodeBetweenLayers":140,"elk.spacing.nodeNode":100,"elk.layered.considerModelOrder.strategy":"NODES_AND_EDGES","elk.edgeRouting":"POLYLINE"}};else r={name:"dagre",rankDir:"TB"===a?"TB":"LR",nodeSep:120,rankSep:140,fit:!1,animate:"end",animationDuration:300};o.layout(r).run(),o.once("layoutstop",function(){e.measureAndResizeNodes&&e.measureAndResizeNodes(o,{maxWidth:240,padding:16}),requestAnimationFrame(()=>e.__cldSafeFit(o))})}}}(),"loading"===t.readyState?t.addEventListener("DOMContentLoaded",function(){r(),i()}):(r(),i())}();V&&V.addEventListener("click",function(){i(function(){try{x(),e.__wesh_sim_chart&&e.__wesh_sim_chart.update()}catch(e){console.error(e)}})})}),function(){function n(){var n=t.getElementById("model-switch");if(n){try{var a=localStorage.getItem("waterCLD.activeModel");a&&(n.value=a)}catch(e){}n.addEventListener("change",function(){e.loadModelFromUrl(n.value)}),n.value&&e.loadModelFromUrl(n.value)}}"loading"===t.readyState?t.addEventListener("DOMContentLoaded",n):n()}(),e.CLDSim={simulate:g,runLayout:function(t,n){return e.runLayout(t,n)},resetScenario:x,parseModel:y,simulateStep:m}}(),function(){if(!e.__WATER_KERNEL_ADAPTER__){e.__WATER_KERNEL_ADAPTER__=!0;var n=e.waterKernel;if(n){var a=!1;t.addEventListener("model:updated",o,{once:!0}),t.addEventListener("model:loaded",o,{once:!0}),n.onReady("cy",function(){try{var t=e.cy;if(!t)return;function r(){try{if(t&&t.elements&&t.elements().length>0)return n.emit("GRAPH_READY",{count:t.elements().length}),!0}catch(e){}return!1}if(r())return;var a=!1;function i(){!a&&r()&&(a=!0,s())}function s(){try{t.off("add",i)}catch(e){}try{t.off("layoutstop",i)}catch(e){}}try{t.on("add",i)}catch(c){}try{t.on("layoutstop",i)}catch(l){}var o=8;!function e(){a||i()||--o<=0||setTimeout(e,50)}()}catch(d){}})}else console&&console.warn&&console.warn("[kernel-adapter] kernel missing")}function o(e){if(!a){a=!0;try{n.emit("MODEL_LOADED",e&&e.detail||{})}catch(e){}}}}(),function(){if(!e.__WATER_KERNEL__){e.__WATER_KERNEL__=!0,d.prototype.on=function(e,t){return(this._[e]||(this._[e]=[])).push(t),t},d.prototype.off=function(e,t){var n=this._[e];if(n){var a=n.indexOf(t);a>-1&&n.splice(a,1)}},d.prototype.emit=function(e,t){for(var n=this._[e]||[],a=0;a<n.length;a++)try{n[a](t)}catch(e){}};var n={};["BOOT","VENDORS_READY","CY_READY","MODEL_LOADED","GRAPH_READY"].forEach(function(e,t){n[e]=t});var a={vendors:"VENDORS_READY",cy:"CY_READY",model:"MODEL_LOADED",graph:"GRAPH_READY"},o=new d,r="BOOT",i={vendors:[],cy:[],model:[],graph:[]},s=Object.create(null),c=!1;"loading"===t.readyState?t.addEventListener("DOMContentLoaded",h,{once:!0}):h(),t.addEventListener("cy:ready",function(e){p("CY_READY",e&&e.detail&&e.detail.cy)});var l={state:function(){return r},emit:p,onReady:f,onceReady:function(e,t){var n=e+"::"+(t&&t.name||Math.random());if(s[n])return s[n];var r=f(e,function(){try{t()}finally{o.off(a[e]||e,r)}});return s[n]=r,r},queue:function(e,t){(i[e]||(i[e]=[])).push(t)},debug:function(e){return c=!!e,l}};e.waterKernel=e.waterKernel||l}function d(){this._=Object.create(null)}function u(e){var t=i[e]||[];if(t.length)for(var n=t.splice(0,t.length),a=0;a<n.length;a++)try{n[a]()}catch(e){}}function p(e,t){if(a[e]||n[e]){var i=a[e]||e;if(n[i]>n[r])(function(){if(c&&console&&console.log)try{console.log.apply(console,arguments)}catch(e){}})("[kernel] →",r=i,t||""),o.emit(r,t),"VENDORS_READY"===r&&u("vendors"),n[r]>=n.CY_READY&&u("cy"),n[r]>=n.MODEL_LOADED&&u("model"),n[r]>=n.GRAPH_READY&&u("graph");else o.emit(i,t)}}function f(e,t){var i=a[e]||e;if(function(e){return n[a[e]||e]<=n[r]}(e)){try{t()}catch(e){}return t}return o.on(i,t)}function h(){p("VENDORS_READY")}}(),function(){if(e.__PARAM_CHIPS__)return;e.__PARAM_CHIPS__=!0;const n=["p-eff","p-dem","p-delay"];function a(){const e={};return n.forEach(n=>{const a=t.getElementById(n);a&&(e[n]="range"===a.type?+a.value:a.value)}),e}let o=null;t.addEventListener("model:updated",function(){const e=a();if(!o)return void(o=e);const n={};Object.keys(e).forEach(t=>{e[t]!==o[t]&&(n[t]={from:o[t],to:e[t]})}),Object.keys(n).length&&function(e){let n=t.getElementById("param-chips");if(!n){n=t.createElement("div"),n.id="param-chips";const e=t.querySelector("#panel-param .actions")||t.querySelector("#panel-param");e?.after(n)}n.innerHTML="",Object.entries(e).forEach(([e,a])=>{const o=t.createElement("span");o.className="param-chip",o.textContent=`${e.replace("p-","")} ${a.from} → ${a.to}`,n.appendChild(o)})}(n),o=e}),"loading"!==t.readyState?o=a():e.addEventListener("DOMContentLoaded",()=>{o=a()},{once:!0})}(),function(){if(e.__CLD_PATHS_BOUND__)return;e.__CLD_PATHS_BOUND__=!0;const n=(e,n=t)=>n.querySelector(e);function a(){if(n("#paths-card"))return;const e=n("#cld-control-hub .mode .ac-body")||n("#cld-control-hub .ac-body")||n("#right-panel")||n("#hero-kpi")||t.body;if(!e)return;const a=t.createElement("section");a.id="paths-card",a.className="paths-card",a.dir="rtl",a.innerHTML='\n      <h4>مسیر علّی و حلقه‌ها</h4>\n      <div class="find-controls">\n        <div class="row">\n          <input id="node-search" list="node-list" placeholder="جست‌وجوی نود…">\n          <datalist id="node-list"></datalist>\n          <button id="btn-zoom">Zoom</button>\n        </div>\n        <div class="row">\n          <select id="target-select"><option value="">هدف (KPI)…</option></select>\n          <button id="btn-find-paths">یافتن مسیر</button>\n          <button id="btn-clear">پاک‌کردن</button>\n        </div>\n      </div>\n      <div class="paths-list" id="paths-list"></div>\n      <div class="loops-bar" id="loops-bar"></div>\n      <div class="note">نکته: حداکثر ۳ مسیر کوتاه نمایش داده می‌شود؛ روی هر مسیر/حلقه کلیک کنید تا در بوم های‌لایت شود.</div>\n    ',e.appendChild(a)}function o(e){a();const o=e=>(e.data("label")??e.data("name")??e.data("title")??e.id()).toString(),r=e=>(e.data("sign")??e.data("polarity")??(Number(e.data("weight"))>=0?1:-1))>=0?"+":"–";function i(){const a=n("#node-list");if(!a)return;a.innerHTML="",e.nodes().forEach(e=>{const n=t.createElement("option");n.value=o(e),n.setAttribute("data-id",e.id()),a.appendChild(n)});const r=n("#target-select");if(!r)return;const i=r.value;r.innerHTML='<option value="">هدف (KPI)…</option>',e.nodes().forEach(e=>{const n=t.createElement("option");n.value=e.id(),n.textContent=o(e),r.appendChild(n)}),i&&(r.value=i)}function s(t){if(!t)return null;let n=e.nodes().filter(e=>o(e)===t);return n.length?n[0]:(n=e.nodes().filter(e=>o(e).toLowerCase().includes(t.toLowerCase())),n.length?n[0]:null)}function c(t,n="cy-path-active"){const a=t.union?t:e.collection(t);e.batch(()=>{e.elements().not(a).addClass("cy-dim"),a.removeClass("cy-dim"),a.addClass(n)})}function l(){const a=n("#loops-bar");if(!a)return;a.innerHTML="";const i=function(t=6,n=12){const a=[],i=(t,n)=>{const i=n.reduce((e,t)=>e*("+"===r(t)?1:-1),1)>=0?"R":"B",s=t.map(e=>o(e)).join(" → ");a.push({type:i,nodes:e.collection(t),edges:e.collection(n),label:s})},s={};if(e.edges().forEach(e=>{const t=e.data("loopId")||e.data("group")||null;t&&(s[t]=s[t]||[]).push(e)}),Object.entries(s).forEach(([e,t])=>{const n=[];t.forEach(e=>{n.push(e.source()),n.push(e.target())}),t.length>=2&&i(n,t)}),a.length>=n)return a.slice(0,n);const c=new Set;return e.edges().forEach(e=>{if(a.length>=n)return;const o=e.source(),r=e.target(),s=[{node:r,pathN:[o,r],pathE:[e],depth:1}];for(;s.length&&a.length<n;){const e=s.pop();if(!(e.depth>t)){if(e.node.id()===o.id()&&e.pathE.length>=2){const t=e.pathN.map(e=>e.id()).join(">");c.has(t)||(c.add(t),i(e.pathN.slice(),e.pathE.slice()));continue}e.node.outgoers("edge").forEach(t=>{const n=t.target();e.pathN.includes(n)||s.push({node:n,pathN:e.pathN.concat(n),pathE:e.pathE.concat(t),depth:e.depth+1})})}}}),a.slice(0,n)}(6,12);let s=0,l=0;if(i.forEach(e=>{const n="R"===e.type?++s:++l,o=t.createElement("button");o.className="loop-chip "+("R"===e.type?"r":"b"),o.type="button",o.innerHTML=`${e.type}${n} <span class="hint">— ${e.label}</span>`,o.addEventListener("click",()=>{c(e.nodes.union(e.edges),"cy-loop-active"),t.dispatchEvent(new CustomEvent("loop:highlighted",{detail:{type:e.type,size:e.edges.length}}))}),a.appendChild(o)}),!i.length){const e=t.createElement("div");e.className="note",e.textContent="حلقهٔ معناداری یافت نشد (یا دادهٔ loopId/group موجود نیست).",a.appendChild(e)}}i(),e.one("layoutstop",i),n("#btn-zoom")?.addEventListener("click",()=>{const t=n("#node-search")?.value?.trim(),a=s(t);a&&(e.animate({fit:{eles:a,padding:60},duration:240}),a.flashClass=(e,t=700)=>{a.addClass(e),setTimeout(()=>a.removeClass(e),t)},a.flashClass("cy-path-active",800))}),n("#btn-clear")?.addEventListener("click",function(){e.batch(()=>{e.elements().removeClass("cy-dim cy-path-active cy-loop-active")}),n("#paths-list")&&(n("#paths-list").innerHTML="")}),n("#btn-find-paths")?.addEventListener("click",()=>{const a=n("#node-search")?.value?.trim(),i=s(a),l=n("#target-select")?.value,d=l?e.getElementById(l):null;if(!i||!d||!d.isNode())return;const u=function(t,n,a=3,o=6){if(!t||!n||t.id()===n.id())return[];const r=[],i=new Set,s=[{node:t,pathNodes:[t],pathEdges:[],depth:0}];for(;s.length&&r.length<a;){const e=s.shift();if(!(e.depth>o)){if(e.node.id()===n.id()){const t=e.pathNodes.map(e=>e.id()).join(">");i.has(t)||(i.add(t),r.push(e));continue}e.node.outgoers("edge").forEach(t=>{const n=t.target();e.pathNodes.includes(n)||s.push({node:n,pathNodes:e.pathNodes.concat(n),pathEdges:e.pathEdges.concat(t),depth:e.depth+1})})}}return r.map(t=>({nodes:e.collection(t.pathNodes),edges:e.collection(t.pathEdges)}))}(i,d,3,6);!function(e){const a=n("#paths-list");a&&(a.innerHTML="",e.forEach((e,n)=>{const i=e.nodes.map(e=>o(e)).join(" → "),s=e.edges.map(e=>r(e)).join(" "),c=t.createElement("div");c.className="path-item",c.innerHTML=`<div class="label">مسیر ${n+1}: ${i} <span style="opacity:.7">(${s})</span></div>\n                          <div class="acts">\n                            <button data-act="hl" data-idx="${n}">های‌لایت</button>\n                          </div>`,a.appendChild(c)}),a.addEventListener("click",n=>{if("hl"===n.target?.dataset?.act){const a=Number(n.target.dataset.idx),o=e[a];if(!o)return;c(o.nodes.union(o.edges),"cy-path-active"),t.dispatchEvent(new CustomEvent("path:highlighted",{detail:{length:o.edges.length}}))}},{once:!0}))}(u),u[0]&&c(u[0].nodes.union(u[0].edges),"cy-path-active")}),e.on("tap","node",((e,t=80)=>{let n;return(...a)=>{clearTimeout(n),n=setTimeout(()=>e(...a),t)}})(e=>{const t=e.target,a=n("#node-search");a&&(a.value=o(t))},60)),l(),e.one("layoutstop",l)}e.onCyReady||(e.onCyReady=function(n){if(e.cy&&"function"==typeof e.cy.on)try{n(e.cy)}catch(e){}else t.addEventListener("cy:ready",t=>{const a=t.detail?.cy||e.cy;if(a)try{n(a)}catch(e){}},{once:!0}),"loading"!==t.readyState?setTimeout(()=>{if(e.cy)try{n(e.cy)}catch(e){}},0):t.addEventListener("DOMContentLoaded",()=>{if(e.cy)try{n(e.cy)}catch(e){}},{once:!0})}),e.graphStore&&"function"==typeof e.graphStore.run?graphStore.run(o):onCyReady(o)}(),function(){if(e.__CLD_PRESETS_BOUND__)return;e.__CLD_PRESETS_BOUND__=!0;const n=(e,n=t)=>n.querySelector(e);function a(){try{if(e.ModelBridge?.getAllParams)return e.ModelBridge.getAllParams()}catch(e){}const n={};return((e,n=t)=>Array.from(n.querySelectorAll(e)))("[data-param]").forEach(e=>{const t=e.dataset.param;if(!t)return;const a="checkbox"===e.type?e.checked?1:0:Number(e.value??e.getAttribute("value"));Number.isNaN(a)||(n[t]=a)}),n}function o(n,a){if(e.ModelBridge?.setParam)try{return e.ModelBridge.setParam(n,a)}catch(e){}const o=t.querySelector(`[data-param="${n}"]`)||t.getElementById(n)||t.querySelector(`input[name="${n}"], select[name="${n}"]`);return!!o&&("checkbox"===o.type?(o.checked=!!a,o.dispatchEvent(new Event("change",{bubbles:!0})),!0):(o.value=String(a),o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0})),!0))}function r(e,n){const a=t.querySelector(`[data-param="${e}"]`)||t.getElementById(e)||t.querySelector(`input[name="${e}"], select[name="${e}"]`);if(!a)return n;const o=""!==a.min?Number(a.min):null,r=""!==a.max?Number(a.max):null;let i=Number(n);return null!=o&&i<o&&(i=o),null!=r&&i>r&&(i=r),i}function i(e){const n=a();for(const t of e)if(null!=n[t])return t;for(const n of e)if(t.querySelector(`[data-param="${n}"]`)||t.getElementById(n)||t.querySelector(`input[name="${n}"], select[name="${n}"]`))return n;return null}const s=[{id:"leakage20",title:"کاهش تلفات ۳۰→۲۰٪",note:"تنظیم مستقیم پارامتر تلفات شبکه به ۲۰٪ (یا 0.20).",apply:()=>{const e=i(["leakage_rate","leakage","loss_rate","nrw","non_revenue_water"]);if(!e)return{ok:!1,msg:"پارامتر تلفات پیدا نشد"};const n=function(e){const n=t.querySelector(`[data-param="${e}"]`)||t.getElementById(e)||t.querySelector(`input[name="${e}"], select[name="${e}"]`);if(!n)return!1;const a=""!==n.max?Number(n.max):null;return null!=a&&a>1.5}(e),a=r(e,n?20:.2);return o(e,a),{ok:!0,msg:`${e} ← ${a}`}}},{id:"drought25",title:"شوک خشکسالی (–۲۵٪ منابع)",note:"کاهش ۲۵٪ در پارامترهای مرتبط با منابع/ورودی آب.",apply:()=>{const e=[],t=a();if(["renewable_supply","available_water","supply","supply_factor","surface_inflow","inflow","groundwater_recharge","recharge"].forEach(n=>{if(null!=t[n]){const a=r(n,.75*Number(t[n]));o(n,a)&&e.push(`${n}←${a}`)}}),!e.length){const t=i(["drought_shock","supply_shock"]);t&&(o(t,-.25),e.push(`${t}←-0.25`))}return e.length?{ok:!0,msg:e.join(" , ")}:{ok:!1,msg:"پارامتر منبع پیدا نشد"}}},{id:"demand-10",title:"مدیریت تقاضا (–۱۰٪ سرانه)",note:"کاهش ۱۰٪ در مصرف سرانه یا فاکتور تقاضا.",apply:()=>{const e=a(),t=[];return["per_capita_use","per_capita_demand","dem","demand_factor","consumption_factor"].forEach(n=>{if(null!=e[n]){const a=r(n,.9*Number(e[n]));o(n,a)&&t.push(`${n}←${a}`)}}),t.length?{ok:!0,msg:t.join(" , ")}:{ok:!1,msg:"پارامتر تقاضا/سرانه پیدا نشد"}}}];function c(){const a=function(){const e=n("#hero-kpi");return e?e.querySelector(".baseline-row")||e:null}();if(!a)return;if(n("#preset-bar"))return;const o=t.createElement("div");o.id="preset-bar",o.className="preset-bar",o.dir="rtl",s.forEach((n,a)=>{const i=t.createElement("button");if(i.className="preset-btn",i.type="button",i.setAttribute("data-preset",n.id),i.textContent=n.title,i.addEventListener("click",async()=>{const a=n.apply();await async function(){if(e.ModelBridge?.rerunModel)try{return void await e.ModelBridge.rerunModel()}catch(e){}t.dispatchEvent(new CustomEvent("model:updated",{detail:{source:"presets"}}))}(),r.innerHTML=`✓ ${n.note} — <span style="opacity:.8">${a.msg||""}</span>           <a href="#" data-more="${n.id}">جزئیات فرض</a>`,t.dispatchEvent(new CustomEvent("scenario:applied",{detail:{id:n.id,title:n.title}}))}),o.appendChild(i),a<s.length-1){const e=t.createElement("div");e.className="preset-sep",o.appendChild(e)}});const r=t.createElement("div");r.className="preset-note",r.textContent="سناریوهای آماده برای شروع سریع تحلیل.",r.addEventListener("click",e=>{const t=e.target?.dataset?.more;if(!t)return;e.preventDefault();const n=s.find(e=>e.id===t);n&&alert(`جزئیات سناریو «${n.title}»:\n\n${n.note}\n\n(برای توضیحات کامل، به کارت Model/Policy مراجعه کنید.)`)}),a.appendChild(o),a.appendChild(r)}function l(){c()}"complete"===t.readyState||"interactive"===t.readyState?l():e.addEventListener("DOMContentLoaded",l,{once:!0})}(),function(){if(e.__PROVENANCE_BOUND__)return;e.__PROVENANCE_BOUND__=!0;const n=(e,n=t)=>n.querySelector(e),a=(e,t="—")=>null==e||""===e?t:e,o=e=>t.querySelector(`meta[name="${e}"]`)?.content||null;function r(){return{MODEL:e.MODEL_VERSION||o("model-version")||"v?",DATA:e.DATA_VERSION||o("data-version")||"v?",UI:e.UI_VERSION||o("ui-version")||"v?",GIT:e.GIT_COMMIT||o("git-commit")||"—",UPDATED:e.DATA_UPDATED||o("data-updated")||null}}function i(){const t=e.Model?.metrics||e.Sim?.metrics||e.__state?.metrics||{};return{MAPE:t.MAPE??null,RMSE:t.RMSE??null,R2:t.R2??null,extreme:t.ExtremeConditions??t.extreme??null,note:t.note||null}}function s(){return{A:e.Model?.assumptions||e.DATA_ASSUMPTIONS||[],L:e.Model?.limitations||e.DATA_LIMITATIONS||[]}}function c(){return((e,n=t)=>Array.from(n.querySelectorAll(e)))("[data-provenance], figure[data-provenance], .chart-card, canvas[data-chart]").map(e=>{e.getBoundingClientRect();return{el:e,title:e.dataset.title||e.getAttribute("aria-label")||e.querySelector("h4,h5,.title")?.textContent||"Chart",unit:e.dataset.unit||o("default-unit")||"",source:e.dataset.source||o("data-source")||"—",updated:e.dataset.updated||o("data-updated")||r().UPDATED||"—",version:e.dataset.version||r().DATA,csv:e.dataset.csv||"",img:null}})}function l(){!function(){if(n("#prov-modal"))return;const e=t.createElement("div");e.id="prov-modal",e.dir="rtl",e.innerHTML='\n      <div id="prov-backdrop"></div>\n      <div id="prov-card">\n        <div class="prov-head">\n          <h3>Model / Policy Card</h3>\n          <button id="prov-copy" class="prov-btn-sm">کپی JSON</button>\n          <button id="prov-close" class="prov-close">بستن</button>\n        </div>\n        <div class="prov-grid">\n          <section class="prov-sec" id="prov-goal">\n            <h4>هدف و محدوده</h4>\n            <div class="prov-note" id="prov-goal-text">هدف: کاهش شکاف عرضه–تقاضا؛ محدوده: شهری/منطقه‌ای (قابل ویرایش در کد).</div>\n          </section>\n          <section class="prov-sec" id="prov-versions">\n            <h4>نسخه‌ها</h4>\n            <div class="prov-kv">\n              <div class="k">Model</div><div id="prov-model">—</div>\n              <div class="k">Data</div><div id="prov-data">—</div>\n              <div class="k">UI</div><div id="prov-ui">—</div>\n              <div class="k">Commit</div><div id="prov-git">—</div>\n              <div class="k">Updated</div><div id="prov-updated">—</div>\n            </div>\n          </section>\n          <section class="prov-sec" id="prov-calib">\n            <h4>کالیبراسیون/اعتبارسنجی</h4>\n            <div class="prov-kv">\n              <div class="k">MAPE</div><div id="prov-mape">—</div>\n              <div class="k">RMSE</div><div id="prov-rmse">—</div>\n              <div class="k">R²</div><div id="prov-r2">—</div>\n              <div class="k">Extreme cond.</div><div id="prov-xt">—</div>\n            </div>\n            <div class="prov-note" id="prov-calib-note">—</div>\n          </section>\n          <section class="prov-sec" id="prov-assump">\n            <h4>فرض‌ها و محدودیت‌ها</h4>\n            <div class="prov-kv">\n              <div class="k">فرض‌ها</div><div id="prov-A">—</div>\n              <div class="k">محدودیت‌ها</div><div id="prov-L">—</div>\n            </div>\n          </section>\n        </div>\n        <div class="prov-actions">\n          <button id="prov-export" class="prov-btn-sm">دانلود کارت (JSON)</button>\n        </div>\n      </div>\n    ',t.body.appendChild(e),n("#prov-backdrop").addEventListener("click",d),n("#prov-close").addEventListener("click",d),n("#prov-copy").addEventListener("click",u),n("#prov-export").addEventListener("click",p)}();const e=r(),o=i(),{A:c,L:l}=s();n("#prov-model").textContent=e.MODEL,n("#prov-data").textContent=e.DATA,n("#prov-ui").textContent=e.UI,n("#prov-git").textContent=e.GIT,n("#prov-updated").textContent=a(e.UPDATED,"—"),n("#prov-mape").textContent=o.MAPE??"—",n("#prov-rmse").textContent=o.RMSE??"—",n("#prov-r2").textContent=o.R2??"—",n("#prov-xt").textContent=null==o.extreme?"—":String(!!o.extreme),n("#prov-calib-note").textContent=o.note||"—",n("#prov-A").textContent=Array.isArray(c)&&c.length?c.join("؛ "):"—",n("#prov-L").textContent=Array.isArray(l)&&l.length?l.join("؛ "):"—",n("#prov-modal").style.display="block"}function d(){const e=n("#prov-modal");e&&(e.style.display="none")}function u(){navigator.clipboard?.writeText(JSON.stringify(f(),null,2))}function p(){const e=new Blob([JSON.stringify(f(),null,2)],{type:"application/json"}),n=t.createElement("a");n.href=URL.createObjectURL(e),n.download=`model-policy-card-${(new Date).toISOString().slice(0,10)}.json`,n.click(),setTimeout(()=>URL.revokeObjectURL(n.href),500)}function f(){const e=r(),t=i(),{A:n,L:a}=s();return{app:{path:location.pathname,tz:Intl.DateTimeFormat().resolvedOptions().timeZone},versions:e,metrics:t,assumptions:n,limitations:a}}function h(){c().forEach(n=>{const o=n.el;if(!o||o.__provMounted)return;o.__provMounted=!0;const r=t.createElement("div");r.className="prov-badge",r.dir="rtl",r.innerHTML=`<span>ⓘ منشأ</span><span style="opacity:.7">نسخه ${n.version}</span>`,o.style.position=o.style.position||"relative",o.appendChild(r);const i=t.createElement("div");function s(){const e=r.getBoundingClientRect(),t=i.offsetWidth||260,n=i.offsetHeight||140;let a=Math.max(8,e.left-(t-e.width)),o=e.top-n-8;o<8&&(o=e.bottom+8),i.style.left=`${a}px`,i.style.top=`${o}px`}i.className="prov-tip",i.innerHTML=`\n        <h5>${n.title}</h5>\n        <div class="row"><strong>منبع:</strong> <span>${a(n.source)}</span></div>\n        <div class="row"><strong>به‌روزرسانی:</strong> <span>${a(n.updated)}</span></div>\n        <div class="row"><strong>واحد:</strong> <span>${a(n.unit,"—")}</span></div>\n        <div class="row"><strong>نسخه داده:</strong> <span>${a(n.version)}</span></div>\n        <div class="act">\n          <a class="prov-link" data-act="csv">دانلود CSV</a>\n          <a class="prov-link" data-act="png">دانلود PNG</a>\n        </div>\n      `,t.body.appendChild(i);let c=!1;r.addEventListener("click",e=>{e.stopPropagation(),c=!c,i.style.display=c?"block":"none",c&&s()}),t.addEventListener("click",()=>{c&&(c=!1,i.style.display="none")}),i.addEventListener("click",a=>{const r=a.target?.dataset?.act;if(r){if(a.preventDefault(),"csv"===r){if(n.csv)return void e.open(n.csv,"_blank");const a=function(e){try{const t="CANVAS"===e.tagName?e:e.querySelector("canvas"),n=t&&t.__chartist||t?.__chartjs||t?.chart||null,a=n?.config||n;if(!a?.data)return null;const{labels:o=[],datasets:r=[]}=a.data,i=[],s=["label",...r.map(e=>e.label||"series")];i.push(s.join(","));const c=Math.max(o.length,...r.map(e=>e.data?.length||0));for(let e=0;e<c;e++){const t=[JSON.stringify(o[e]??"")];r.forEach(n=>t.push(n.data?.[e]??"")),i.push(t.join(","))}return i.join("\n")}catch(e){return null}}(o);if(!a)return void alert("CSV در دسترس نیست. data-csv را تنظیم کنید.");const r=new Blob([a],{type:"text/csv"}),i=t.createElement("a");i.href=URL.createObjectURL(r),i.download=`${n.title.replace(/\s+/g,"_")}.csv`,i.click(),setTimeout(()=>URL.revokeObjectURL(i.href),500)}if("png"===r){const e=function(e){const t="CANVAS"===e.tagName?e:e.querySelector("canvas");if(!t)return null;try{return t.toDataURL("image/png")}catch(e){return null}}(o);if(!e)return void alert("PNG در دسترس نیست (canvas یافت نشد).");const a=t.createElement("a");a.href=e,a.download=`${n.title.replace(/\s+/g,"_")}.png`,a.click()}}}),e.addEventListener("resize",()=>{c&&s()}),e.addEventListener("scroll",()=>{c&&s()},!0)})}function y(){!function(){const e=n("#hero-kpi")||t.body;if(!e||n("#prov-open-btn"))return;const a=t.createElement("button");a.id="prov-open-btn",a.type="button",a.className="prov-btn",a.dir="rtl",a.innerHTML='<span class="dot"></span><span>اطلاعات مدل/سیاست</span>',(e.querySelector(".baseline-row")||e).appendChild(a),a.addEventListener("click",l)}(),h()}"complete"===t.readyState||"interactive"===t.readyState?y():e.addEventListener("DOMContentLoaded",y,{once:!0}),t.addEventListener("model:updated",()=>{h()})}(),function(){if(e.__QUICK_PRESET__)return;e.__QUICK_PRESET__=!0;const n=e.localStorage;function a(){if(e.ModelBridge?.setParam)try{e.ModelBridge.setParam("leakage_rate",.2)}catch(e){}!async function(){t.dispatchEvent(new CustomEvent("model:updated",{detail:{source:"quick-preset"}}))}()}function o(){try{if("1"===n.getItem("seenAha"))return}catch(e){}const e=t.createElement("div");e.className="quick-cta",e.id="quick-cta",e.innerHTML='<button id="cta-see-effect" class="btn">اثر سیاست نمونه را ببین</button><span class="hint">۲ کلیک تا دیدن اثر روی KPIها</span>';const o=t.getElementById("hero-kpi")||t.body;o.parentElement.insertBefore(e,o),e.querySelector("#cta-see-effect").addEventListener("click",()=>{a();try{n.setItem("seenAha","1")}catch(e){}})}"loading"!==t.readyState?o():e.addEventListener("DOMContentLoaded",o,{once:!0})}(),function(){if(e.__SCENARIO_SUITE_BOUND__)return;e.__SCENARIO_SUITE_BOUND__=!0;const n=(e,n=t)=>n.querySelector(e),a=e.localStorage,o={supply_demand_gap:{label:"شکاف عرضه–تقاضا",unit:"%",better:"lower"},per_capita_use:{label:"مصرف سرانه",unit:"L/day",better:"lower"},leakage_rate:{label:"نرخ تلفات شبکه",unit:"%",better:"lower"}},r="cld_recent_scenarios",i="cld_pinned_baseline";function s(e){return t.querySelector(`[data-param="${e}"]`)||t.getElementById(e)||t.querySelector(`input[name="${e}"], select[name="${e}"]`)}function c(){try{if(e.ModelBridge?.getAllParams)return e.ModelBridge.getAllParams()}catch(e){}const n={};return((e,n=t)=>Array.from(n.querySelectorAll(e)))("[data-param]").forEach(e=>{const t=e.dataset.param;if(!t)return;const a="checkbox"===e.type?e.checked?1:0:Number(e.value??e.getAttribute("value"));Number.isNaN(a)||(n[t]=a)}),n}function l(t,n){if(e.ModelBridge?.setParam)try{return e.ModelBridge.setParam(t,n)}catch(e){}const a=s(t);return!!a&&("checkbox"===a.type?(a.checked=!!n,a.dispatchEvent(new Event("change",{bubbles:!0})),!0):(a.value=String(n),a.dispatchEvent(new Event("input",{bubbles:!0})),a.dispatchEvent(new Event("change",{bubbles:!0})),!0))}async function d(){if(e.ModelBridge?.rerunModel)try{return void await e.ModelBridge.rerunModel()}catch(e){}t.dispatchEvent(new CustomEvent("model:updated",{detail:{source:"scenario-suite"}}))}function u(t){try{if(e.ModelBridge?.getKPI){const n=e.ModelBridge.getKPI(t);if(null!=n)return Number(n)}}catch(e){}const n=c();if("per_capita_use"===t&&null!=n.dem)return+(350*Number(n.dem)).toFixed(1);if("leakage_rate"===t){if(null!=n.leakage_rate)return+Number(n.leakage_rate).toFixed(1);if(null!=n.eff){const e=24.8;return+Math.max(0,e*(1-.2*(Number(n.eff)-.3))).toFixed(1)}}if("supply_demand_gap"===t&&null!=n.dem&&null!=n.eff){const e=Math.max(.01,Number(n.dem)),t=Math.max(.01,.7*Number(n.eff)+.3);return+Math.max(0,(e-t)/Math.max(e,1)*100).toFixed(1)}return null}function p(e,t){const n=s(e);if(!n)return t;const a=""!==n.min?Number(n.min):null,o=""!==n.max?Number(n.max):null;let r=Number(t);return null!=a&&r<a&&(r=a),null!=o&&r>o&&(r=o),r}function f(e){const t=c();for(const n of e)if(null!=t[n]||s(n))return n;return null}const h=[{id:"leakage20",title:"کاهش تلفات ۳۰→۲۰٪",note:"تنظیم تلفات شبکه به ۲۰٪ (یا 0.20).",apply:()=>{const e=f(["leakage_rate","leakage","loss_rate","nrw","non_revenue_water"]);if(!e)return{ok:!1,msg:"پارامتر تلفات یافت نشد"};const t=function(e){const t=s(e);if(!t)return!1;const n=""!==t.max?Number(t.max):null;return null!=n&&n>1.5}(e),n=p(e,t?20:.2);return l(e,n),{ok:!0,msg:`${e}←${n}`}}},{id:"drought25",title:"شوک خشکسالی (–۲۵٪ منابع)",note:"کاهش ۲۵٪ پارامترهای مرتبط با منابع/ورودی آب.",apply:()=>{const e=c(),t=[];if(["renewable_supply","available_water","supply","supply_factor","surface_inflow","inflow","groundwater_recharge","recharge"].forEach(n=>{if(null!=e[n]){const a=p(n,.75*Number(e[n]));l(n,a)&&t.push(`${n}←${a}`)}}),!t.length){const e=f(["drought_shock","supply_shock"]);e&&(l(e,-.25),t.push(`${e}←-0.25`))}return t.length?{ok:!0,msg:t.join(" , ")}:{ok:!1,msg:"پارامتر منبع یافت نشد"}}},{id:"demand-10",title:"مدیریت تقاضا (–۱۰٪ سرانه)",note:"کاهش ۱۰٪ در مصرف سرانه/فاکتور تقاضا.",apply:()=>{const e=c(),t=[];return["per_capita_use","per_capita_demand","dem","demand_factor","consumption_factor"].forEach(n=>{if(null!=e[n]){const a=p(n,.9*Number(e[n]));l(n,a)&&t.push(`${n}←${a}`)}}),t.length?{ok:!0,msg:t.join(" , ")}:{ok:!1,msg:"پارامتر تقاضا/سرانه یافت نشد"}}}];function y(e="Scenario"){return{name:e,t:Date.now(),params:c()}}async function m(e){return!!e?.params&&(Object.entries(e.params).forEach(([e,t])=>l(e,t)),await d(),!0)}function g(e){const t=`#s=${function(e){const t=JSON.stringify(e);return btoa(unescape(encodeURIComponent(t))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}(e)}`;return history.replaceState(null,"",`${location.pathname}${location.search}${t}`),location.href}function v(){try{return JSON.parse(a.getItem(r)||"[]")}catch(e){return[]}}function _(e){let t=v();t.unshift(e),t=t.slice(0,5);try{a.setItem(r,JSON.stringify(t))}catch(e){}}function E(){const e=n("#hero-kpi");return e?e.querySelector(".baseline-row")||e:null}function b(){const e=E();if(!e)return;if(n("#scn-bar"))return;const o=t.createElement("div");o.id="scn-bar",o.className="scn-bar",o.dir="rtl",h.forEach((e,a)=>{const r=t.createElement("button");if(r.className="scn-btn",r.type="button",r.textContent=e.title,r.setAttribute("data-preset",e.id),r.addEventListener("click",async()=>{const a=e.apply();await d();const o=n("#scn-note");o&&(o.innerHTML=`✓ ${e.note} — <span style="opacity:.8">${a.msg||""}</span>`),t.dispatchEvent(new CustomEvent("scenario:applied",{detail:{id:e.id,title:e.title}}));_(y(e.title))}),o.appendChild(r),a<h.length-1){const e=t.createElement("div");e.className="scn-sep",o.appendChild(e)}});const r=t.createElement("button");r.id="scn-pin",r.className="scn-btn",r.textContent="Pin Baseline",r.addEventListener("click",()=>{!function(e){try{a.setItem(i,JSON.stringify(e))}catch(e){}}({t:Date.now(),name:"Baseline (Pinned)",kpis:L(u)});const e=n("#scn-note");e&&(e.textContent="✓ Baseline پین شد.")});const s=t.createElement("button");s.id="scn-compare-toggle",s.className="scn-btn",s.textContent="Compare",s.addEventListener("click",()=>{n("#scn-panel")?.classList.toggle("open"),C()});const c=t.createElement("button");c.id="scn-share",c.className="scn-btn",c.textContent="Copy Link",c.addEventListener("click",()=>{const e=y("Shared Scenario"),t=g(e);_(e);try{navigator.clipboard.writeText(t)}catch(e){}const a=n("#scn-note");a&&(a.innerHTML="✓ لینک سناریو کپی شد.")});const l=t.createElement("button");l.id="scn-recent",l.className="scn-btn",l.textContent="Recent";const p=t.createElement("div");p.id="scn-recent-pop",p.className="scn-pop",p.dir="rtl";const f=t.createElement("ul");p.appendChild(f),l.addEventListener("click",e=>{e.stopPropagation();const n=v();if(f.innerHTML="",!n.length){const e=t.createElement("li");e.textContent="(خالی)",f.appendChild(e)}n.forEach((e,n)=>{const a=t.createElement("li"),o=new Date(e.t).toLocaleString();a.innerHTML=`<a href="#" data-idx="${n}">${e.name||"Scenario"} • ${o}</a>`,f.appendChild(a)});const a=l.getBoundingClientRect();p.style.display="block",p.style.top=`${a.bottom+6}px`,p.style.left=`${a.left}px`}),t.addEventListener("click",()=>p.style.display="none"),p.addEventListener("click",async e=>{const t=e.target?.dataset?.idx;if(null==t)return;e.preventDefault();const a=v()[Number(t)];if(!a)return;await m(a);const o=n("#scn-note");o&&(o.textContent="✓ سناریوی اخیر اعمال شد."),p.style.display="none"}),o.append(r,s,c,l),e.appendChild(o),e.appendChild(p);const b=t.createElement("div");b.id="scn-note",b.className="scn-note",b.textContent="سناریوهای آماده + Pin/Compare + اشتراک لینک + Recent.",e.appendChild(b)}function L(e){const t={};return Object.keys(o).forEach(n=>t[n]=e(n)),t}function C(){const e=n("#hero-kpi")||t.body;let r=n("#scn-panel");r||(r=t.createElement("div"),r.id="scn-panel",r.className="scn-panel",e.appendChild(r)),r.innerHTML="";const s=function(){try{return JSON.parse(a.getItem(i)||"null")}catch(e){return null}}(),c=L(u);if(!s){const e=t.createElement("div");return e.className="scn-card",e.dir="rtl",e.textContent="ابتدا Baseline را Pin کنید.",void r.appendChild(e)}const l=t.createElement("div");l.className="scn-card",l.dir="rtl";const d=t.createElement("div");d.className="scn-grid",Object.keys(o).forEach(e=>{const n=o[e],a=Number(s.kpis[e]),r=Number(c[e]),i=function(e,t,n){if(null==e||null==t)return{delta:0,dir:"neutral"};const a=o[n],r="lower"===(a?.better||"lower"),i=(t-e)/(Math.abs(e)<1e-9?1:e)*100;let s="neutral";return s=Math.abs(i)<.05?"neutral":i<0&&r||i>0&&!r?"pos":"neg",{delta:i,dir:s}}(a,r,e),l=t.createElement("div");l.className="scn-kpi",l.innerHTML=`\n        <h5>${n.label}</h5>\n        <div class="row">\n          <span class="val">${x(a)?a.toFixed(1):"—"}</span><span class="unit">${n.unit}</span>\n          <span style="opacity:.6">↔</span>\n          <span class="val">${x(r)?r.toFixed(1):"—"}</span><span class="unit">${n.unit}</span>\n          <span class="delta ${i.dir}">${x(i.delta)?Math.abs(i.delta).toFixed(1)+"%":""}</span>\n        </div>`,d.appendChild(l)});const p=t.createElement("div");p.className="scn-meta",p.textContent=`Pinned at: ${new Date(s.t).toLocaleString()}`;const f=t.createElement("button");f.className="scn-btn",f.textContent="Clear Pin",f.addEventListener("click",()=>{!function(){try{a.removeItem(i)}catch(e){}}(),C()}),l.appendChild(d),l.appendChild(p),l.appendChild(f),r.appendChild(l)}function x(e){return"number"==typeof e&&isFinite(e)}async function k(){const e=location.hash.match(/[#&]s=([^&]+)/);if(!e)return;const t=function(e){try{const t=e.replace(/-/g,"+").replace(/_/g,"/"),n=t.length%4?"====".slice(t.length%4):"",a=decodeURIComponent(escape(atob(t+n)));return JSON.parse(a)}catch(e){return null}}(e[1]);if(!t)return;await m(t);const a=n("#scn-note");a&&(a.textContent="✓ سناریو از لینک اعمال شد.")}function S(){E()&&(b(),C(),k())}"complete"===t.readyState||"interactive"===t.readyState?S():e.addEventListener("DOMContentLoaded",S,{once:!0}),t.addEventListener("model:updated",()=>{n("#scn-panel")?.classList.contains("open")&&C()})}(),e.__SPOTLIGHT__||(e.__SPOTLIGHT__=!0,t.addEventListener("model:updated",function(){t.body.classList.add("spot-dim"),setTimeout(()=>t.body.classList.remove("spot-dim"),900)})),function(){if(e.__CLD_TOUR_BOUND__)return;e.__CLD_TOUR_BOUND__=!0;const n=(e,n=t)=>n.querySelector(e),a=(e,n=t)=>Array.from(n.querySelectorAll(e)),o=e.localStorage,r="cld_tour_done",i=new URL(location.href),s="1"===i.searchParams.get("tour");if("reset"===i.searchParams.get("tour")&&o.removeItem(r),!s&&"1"===o.getItem(r))return;let c,l,d,u=0,p=[];function f(t,n="bottom"){if(!t)return;const a=t.getBoundingClientRect();l.style.display="block",l.style.left=`${Math.max(8,a.left-8)}px`,l.style.top=`${Math.max(8,a.top-8)}px`,l.style.width=`${a.width+16}px`,l.style.height=`${a.height+16}px`;let o=a.left,r=a.bottom+10;"right"===n&&(o=a.right+12,r=a.top);const i=e.innerWidth,s=e.innerHeight,c=Math.min(360,d.offsetWidth||320),u=d.offsetHeight||120;o+c+8>i&&(o=Math.max(8,i-c-8)),r+u+8>s&&(r=Math.max(8,a.top-u-12)),d.style.left=`${o}px`,d.style.top=`${r}px`}function h(e){c.style.display="block";const{title:t,html:n,target:a,side:o}=e;d.innerHTML=`\n      <h4>${t}</h4>\n      <p>${n}</p>\n      <div class="cld-tour-actions" dir="rtl">\n        <button class="cld-tour-btn" data-act="skip">عدم نمایش مجدد</button>\n        ${u>0?'<button class="cld-tour-btn" data-act="prev">قبلی</button>':""}\n        <button class="cld-tour-btn primary" data-act="${u<p.length-1?"next":"done"}">\n          ${u<p.length-1?"بعدی":"شروع کنید"}\n        </button>\n      </div>`,f(a(),o||"bottom")}function y(t=!1){e.removeEventListener("resize",m),e.removeEventListener("scroll",m,!0),c&&(c.style.display="none"),l&&(l.style.display="none"),t&&o.setItem(r,"1")}function m(){const e=p[u];e&&f(e.target(),e.side||"bottom")}function g(){const e=p[u]?.target();e||(u++,u<p.length?h(p[u]):y(!0))}function v(){n("#cld-tour-backdrop")?(c=n("#cld-tour-backdrop"),l=n("#cld-tour-focus"),d=n(".cld-tour-pop")):(c=t.createElement("div"),c.id="cld-tour-backdrop",l=t.createElement("div"),l.id="cld-tour-focus",d=t.createElement("div"),d.className="cld-tour-pop",d.dir="rtl",t.body.append(c,l,d)),u=0,h(p[0]),e.addEventListener("resize",m),e.addEventListener("scroll",m,!0),d.addEventListener("click",e=>{const t=e.target?.dataset?.act;t&&("skip"===t?y(!0):"prev"===t?(u=Math.max(0,u-1),h(p[u])):"next"===t?(u=Math.min(p.length-1,u+1),h(p[u])):"done"===t&&y(!0))}),setTimeout(g,400)}p=[{key:"run",title:"۱) اجرای سناریوی نمونه",html:"برای دیدن اثر سیاست، یک سناریوی نمونه را اجرا کنید.",target:function(){let e=n("#btn-run-sample");if(e)return e;if(e=a("button").find(e=>/اجرای.*سناریو|Run.*sample/i.test(e.textContent||"")),e)return e;const t=n("#hero-kpi");return t&&(e=a("button",t).find(e=>/سناریو|Scenario/i.test(e.textContent||"")),e)?e:null},side:"bottom"},{key:"kpi",title:"۲) اثر را در KPI ببینید",html:"این‌جا تغییرات KPI (Δ نسبت به Baseline) نمایش داده می‌شود.",target:function(){return n("#hero-kpi .hero-kpis")||n(".hero-kpis")||n("#hero-kpi")||null},side:"bottom"},{key:"loops",title:"۳) حلقه‌های کلیدی",html:"از این بخش، حلقه‌های تقویتی/تعادلی را انتخاب و مسیرشان را های‌لایت کنید.",target:function(){const t=a('.legend, .loops, [aria-label="Loops"]').find(e=>/Loop|حلقه|Loops/i.test(e.textContent||""));if(t)return t;const n=a("*").find(e=>/Loops/i.test(e?.textContent||"")&&e.clientWidth>120&&e.clientHeight>40);return n||(e.cy&&e.cy.container?e.cy.container():null)},side:"right"}],function(){if(!(s||"1"!==o.getItem(r)))return;const e=()=>v();var n,a;"complete"===t.readyState||"interactive"===t.readyState?e():(n="DOMContentLoaded",a=e,t.addEventListener(n,a,{once:!0})),t.addEventListener("cy:ready",()=>{p[2]&&"function"==typeof p[2].target&&m()})}()}(),t.getElementById("cy")}(window,document);}else{console.warn("[CLD] kernel graph not ready")};