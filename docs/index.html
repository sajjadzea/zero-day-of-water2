<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد وضعیت آب مشهد (مجهز به Gemini)</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%231f7aff'/%3E%3Cpath d='M20 36c8 4 16-4 24 0' stroke='white' stroke-width='4' fill='none'/%3E%3C/svg%3E" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script>
      window.API_BASE = window.location.origin;
      async function askGemini(prompt, opts={}) {
        const res = await fetch('/api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ q: prompt, ...opts })
        });
        if (!res.ok) throw new Error('Gemini request failed');
        const data = await res.json();
        return data.text || '';
      }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;800&display=swap');
        body { font-family: 'Vazirmatn', sans-serif; background-color: #f0f4f8; }
        .main-title { font-weight: 800; color: #1e3a8a; }
        /* --- Cards --- */
        .card-row {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .card {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 8px 20px rgba(0,0,0,.05);
            padding: 1.5rem;
            flex: 1;
            min-width: 280px;
        }

        @media (max-width: 768px) {
            .card-row {
                flex-direction: column;
            }
        }
        .water-drop-container { position: relative; width: 100px; height: 100px; margin: 0 auto; }
        .water-drop-background { position: absolute; bottom: 0; left: 0; right: 0; background-color: #3b82f6; border-radius: 0 0 50px 50px; transition: height 1s ease-out; }
        .water-drop-icon { position: absolute; top: 0; left: 0; width: 100%; height: 100%; -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M192 512C86 512 0 426 0 320C0 228.8 130.2 57.7 166.6 11.7C172.6 4.2 181.5 0 192 0s19.4 4.2 25.4 11.7C253.8 57.7 384 228.8 384 320c0 106-86 192-192 192z"/></svg>'); mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path fill="currentColor" d="M192 512C86 512 0 426 0 320C0 228.8 130.2 57.7 166.6 11.7C172.6 4.2 181.5 0 192 0s19.4 4.2 25.4 11.7C253.8 57.7 384 228.8 384 320c0 106-86 192-192 192z"/></svg>'); -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat; -webkit-mask-position: center; mask-position: center; background-color: #e0e0e0; }
        .days-left-card { background: linear-gradient(135deg, #ef4444, #b91c1c); color: white; }
        .rain-bar { background-color: #93c5fd; border-radius: .5rem; position: relative; }
        .rain-bar-fill { background-color: #1d4ed8; border-radius: .5rem; transition: height 1s ease-out; }
        .btn-gemini { background: linear-gradient(135deg, #4f46e5, #7c3aed); transition: all .3s ease; }
        .btn-gemini:hover { box-shadow: 0 0 20px rgba(79,70,229,.5); }
        input[type=range]{ -webkit-appearance:none; appearance:none; width:100%; height:8px; background:#d1d5db; border-radius:5px; outline:none; opacity:.7; transition:opacity .2s; }
        input[type=range]:hover{ opacity:1; }
        input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:24px; height:24px; background:#3b82f6; cursor:pointer; border-radius:50%; border:3px solid white; box-shadow:0 0 5px rgba(0,0,0,.2); }
        input[type=range]::-moz-range-thumb{ width:24px; height:24px; background:#3b82f6; cursor:pointer; border-radius:50%; border:3px solid white; box-shadow:0 0 5px rgba(0,0,0,.2); }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-extrabold main-title">وضعیت بحرانی آب در مشهد</h1>
            <p class="text-slate-600 text-lg mt-4">آخرین بروزرسانی: شنبه ۱۱ مرداد ۱۴۰۴</p>
        </header>
        <section class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">
            <div class="card days-left-card md:col-span-2 flex flex-col justify-center items-center text-center p-8">
                <i class="fas fa-hourglass-half fa-3x mb-4 opacity-75"></i>
                <h2 class="text-2xl font-bold mb-2">روزهای باقی‌مانده تا روز صفر آبی</h2>
                <p class="text-8xl font-extrabold" id="days-left">32</p>
                <p class="text-2xl font-bold">روز</p>
                <p class="mt-4 text-lg opacity-90">این یک پیش‌بینی بر اساس حجم قابل استفاده فعلی سدها و میانگین مصرف روزانه است.</p>
            </div>
            <div class="card flex flex-col justify-center items-center">
                <i class="fas fa-cloud-showers-heavy fa-3x mb-4 text-blue-500"></i>
                <h2 class="text-xl font-bold text-slate-800 mb-6 text-center">مقایسه بارش امسال با میانگین بلندمدت</h2>
                <div class="w-full flex justify-around items-end h-48">
                    <div class="w-1/3 h-full flex flex-col justify-end items-center"><p class="font-bold text-blue-800 text-lg mb-1">123 <span class="text-sm">میلی‌متر</span></p><div class="rain-bar w-16"><div class="rain-bar-fill" style="height: 59%;"></div></div><p class="mt-2 font-semibold text-slate-600">سال آبی جاری</p></div>
                    <div class="w-1/3 h-full flex flex-col justify-end items-center"><p class="font-bold text-slate-500 text-lg mb-1">208 <span class="text-sm">میلی‌متر</span></p><div class="rain-bar w-16 bg-slate-300"><div class="rain-bar-fill bg-slate-500" style="height: 100%;"></div></div><p class="mt-2 font-semibold text-slate-600">میانگین بلندمدت</p></div>
                </div>
            </div>
        </section>
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-slate-800 text-center mb-8">پایش لحظه‌ای سدها</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card text-center"><h3 class="text-2xl font-bold text-slate-700 mb-4">سد دوستی</h3><div class="water-drop-container mb-4"><div class="water-drop-icon"></div><div class="water-drop-background" style="height: 5%;"></div></div><p class="text-5xl font-extrabold text-blue-600">5%</p><p class="text-slate-500 mt-2">حجم: حدود ۶۵ میلیون متر مکعب</p><div class="mt-4 p-3 bg-amber-100 text-amber-800 rounded-lg text-sm font-semibold border border-amber-200"><i class="fas fa-exclamation-triangle mr-2"></i>نیمی از این حجم متعلق به ترکمنستان است.</div></div>
                <div class="card text-center"><h3 class="text-2xl font-bold text-slate-700 mb-4">سد طرق</h3><div class="water-drop-container mb-4"><div class="water-drop-icon"></div><div class="water-drop-background" style="height: 7%;"></div></div><p class="text-5xl font-extrabold text-blue-600">7%</p><p class="text-slate-500 mt-2">حجم: حدود ۲ میلیون متر مکعب</p></div>
                <div class="card text-center"><h3 class="text-2xl font-bold text-slate-700 mb-4">سد کارده</h3><div class="water-drop-container mb-4"><div class="water-drop-icon"></div><div class="water-drop-background" style="height: 0%;"></div></div><p class="text-5xl font-extrabold text-blue-600">—</p><p class="text-slate-500 mt-2">حجم: حدود ۵ میلیون متر مکعب</p></div>
                <div class="card text-center"><h3 class="text-2xl font-bold text-slate-700 mb-4">سد ارداک</h3><div class="water-drop-container mb-4"><div class="water-drop-icon"></div><div class="water-drop-background" style="height: 0%;"></div></div><p class="text-5xl font-extrabold text-blue-600">—</p><p class="text-slate-500 mt-2">حجم: حدود ۴ میلیون متر مکعب</p></div>
            </div>
        </section>
        <section class="mb-12">
            <div class="card bg-gradient-to-br from-amber-50 via-orange-50 to-red-50 border-2 border-amber-200">
                <h2 class="text-3xl font-bold text-slate-800 text-center mb-2">✨ ردپای پنهان آب: غذای شما چقدر آب می‌نوشد؟ ✨</h2>
                <p class="text-center text-slate-600 mb-8">مواد غذایی یک وعده خود را وارد کنید...</p>
                <div class="max-w-xl mx-auto">
                    <div class="mb-4">
                        <label for="food-input" class="font-semibold text-slate-700 block mb-2">مواد غذایی (با کاما جدا کنید):</label>
                        <input type="text" id="food-input" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition" placeholder="مثال: نان، گوشت گاو، گوجه فرنگی">
                    </div>
                    <div class="text-center">
                        <button id="calculate-footprint-btn" class="btn-gemini bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg"><i class="fas fa-seedling ml-2"></i>محاسبه ردپای آب</button>
                    </div>
                </div>
                <div id="footprint-result-container" class="mt-8 hidden">
                    <div id="footprint-loader" class="text-center"><i class="fas fa-spinner fa-spin fa-3x text-amber-500"></i><p class="mt-2 text-slate-600">در حال محاسبه با هوش مصنوعی...</p></div>
                    <div id="footprint-result" class="p-6 bg-white rounded-lg shadow-inner text-center"></div>
                </div>
            </div>
        </section>
        <section class="mb-12">
            <div class="card bg-gradient-to-br from-green-50 via-teal-50 to-cyan-50 border-2 border-green-200">
                <h2 class="text-3xl font-bold text-slate-800 text-center mb-2">✨ شبیه‌ساز آینده آب مشهد ✨</h2>
                <p class="text-center text-slate-600 mb-8">ببینید مشارکت شما و رحمت الهی چگونه می‌تواند آینده را تغییر دهد!</p>
                <div class="max-w-2xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                        <div><label for="consumption-slider" class="font-semibold text-slate-700 block mb-2">کاهش مصرف همگانی:</label><input type="range" id="consumption-slider" min="0" max="30" value="10" class="w-full"><div class="text-center font-bold text-xl text-blue-600 mt-2"><span id="consumption-value">10</span>%</div></div>
                        <div><label for="rainfall-slider" class="font-semibold text-slate-700 block mb-2">بارش باران در ماه آینده:</label><input type="range" id="rainfall-slider" min="0" max="50" value="5" class="w-full"><div class="text-center font-bold text-xl text-blue-600 mt-2"><span id="rainfall-value">5</span> میلی‌متر</div></div>
                    </div>
                    <div class="text-center"><button id="simulate-btn" class="btn-gemini text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg bg-green-500 hover:bg-green-600"><i class="fas fa-chart-line ml-2"></i>آینده را شبیه‌سازی کن</button></div>
                </div>
                <div id="simulation-result-container" class="mt-8 hidden"><div id="simulation-loader" class="text-center"><i class="fas fa-spinner fa-spin fa-3x text-green-500"></i><p class="mt-2 text-slate-600">در حال تحلیل آینده با هوش مصنوعی...</p></div><div id="simulation-result" class="p-6 bg-white rounded-lg shadow-inner text-center"></div></div>
            </div>
        </section>
        <section class="mb-12">
            <div class="card bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 border-2 border-blue-200">
                <h2 class="text-3xl font-bold text-slate-800 text-center mb-2">✨ راهکارهای هوشمند برای شما ✨</h2>
                <p class="text-center text-slate-600 mb-8">با پاسخ به چند سوال ساده...</p>
                <div class="max-w-xl mx-auto">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
                        <div><label for="family-size" class="font-semibold text-slate-700 block mb-2">تعداد اعضای خانواده:</label><input type="number" id="family-size" value="4" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></div>
                        <div><label for="shower-time" class="font-semibold text-slate-700 block mb-2">مدت زمان حمام (دقیقه):</label><input type="number" id="shower-time" value="10" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></div>
                    </div>
                    <div class="text-center"><button id="generate-tips-btn" class="btn-gemini text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg"><i class="fas fa-magic ml-2"></i>برایم راهکار بساز</button></div>
                </div>
                <div id="tips-result-container" class="mt-8 hidden"><div id="tips-loader" class="text-center"><i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i><p class="mt-2 text-slate-600">در حال آماده‌سازی راهکارهای هوشمند...</p></div><div id="tips-result" class="p-6 bg-white rounded-lg shadow-inner prose prose-vazir max-w-none"></div></div>
            </div>
        </section>
        <section class="mb-12">
            <div class="card-row">
                <div class="card stats-card">
                    <h2 class="text-2xl font-bold text-slate-800 text-center mb-6">آب ما کجا مصرف می‌شود؟</h2>
                    <div class="space-y-5">
                        <div class="flex items-center">
                            <div class="w-16 text-center"><i class="fas fa-leaf fa-2x text-green-500"></i></div>
                            <div class="flex-1 mx-4">
                                <div class="flex justify-between mb-1"><span class="text-base font-semibold text-slate-700">کشاورزی</span><span class="text-sm font-bold text-green-600">57%</span></div>
                                <div class="w-full bg-gray-200 rounded-full h-4"><div class="bg-green-500 h-4 rounded-full" style="width: 57%"></div></div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div class="w-16 text-center"><i class="fas fa-home fa-2x text-cyan-500"></i></div>
                            <div class="flex-1 mx-4">
                                <div class="flex justify-between mb-1"><span class="text-base font-semibold text-slate-700">شرب و بهداشت</span><span class="text-sm font-bold text-cyan-600">31%</span></div>
                                <div class="w-full bg-gray-200 rounded-full h-4"><div class="bg-cyan-500 h-4 rounded-full" style="width: 31%"></div></div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div class="w-16 text-center"><i class="fas fa-building fa-2x text-purple-500"></i></div>
                            <div class="flex-1 mx-4">
                                <div class="flex justify-between mb-1"><span class="text-base font-semibold text-slate-700">خدمات</span><span class="text-sm font-bold text-purple-600">7%</span></div>
                                <div class="w-full bg-gray-200 rounded-full h-4"><div class="bg-purple-500 h-4 rounded-full" style="width: 7%"></div></div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div class="w-16 text-center"><i class="fas fa-industry fa-2x text-slate-500"></i></div>
                            <div class="flex-1 mx-4">
                                <div class="flex justify-between mb-1"><span class="text-base font-semibold text-slate-700">صنعت</span><span class="text-sm font-bold text-slate-600">3%</span></div>
                                <div class="w-full bg-gray-200 rounded-full h-4"><div class="bg-slate-500 h-4 rounded-full" style="width: 3%"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card tips-card">
                    <h2 class="text-2xl font-bold text-blue-800 text-center mb-6">چگونه می‌توانیم کمک کنیم؟</h2>
                    <ul class="space-y-4 text-slate-700">
                        <li class="flex items-start"><i class="fas fa-faucet-drip fa-lg text-blue-500 mt-1 ml-4"></i><span><strong>شیرهای آب چکه کن را تعمیر کنیم.</strong> ...</span></li>
                        <li class="flex items-start"><i class="fas fa-shower fa-lg text-blue-500 mt-1 ml-4"></i><span><strong>زمان حمام را کوتاه کنیم.</strong> ...</span></li>
                        <li class="flex items-start"><i class="fas fa-car fa-lg text-blue-500 mt-1 ml-4"></i><span><strong>برای شستن ماشین از سطل آب استفاده کنیم.</strong> ...</span></li>
                        <li class="flex items-start"><i class="fas fa-tooth fa-lg text-blue-500 mt-1 ml-4"></i><span><strong>هنگام مسواک زدن شیر آب را ببندیم.</strong> ...</span></li>
                    </ul>
                </div>
            </div>
        </section>
        <footer class="text-center mt-12 text-slate-500 text-sm">
            <p>این داشبورد بر اساس داده‌های «آمارنامه آب مشهد مقدس - شماره ۱۷۰» ...</p>
            <p>هدف، افزایش آگاهی عمومی ... بخش‌های هوشمند توسط Google Gemini ارائه می‌شود.</p>
        </footer>
    </div>
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4"><div class="bg-white p-6 rounded-lg shadow-lg max-w-sm mx-auto text-center"><div class="text-red-500 mb-4"><i class="fas fa-exclamation-circle fa-3x"></i></div><h3 class="text-lg font-bold text-red-600 mb-2">خطا در ارتباط با سرور</h3><p id="error-message" class="text-slate-700">متاسفانه مشکلی در دریافت اطلاعات پیش آمد. لطفا دوباره تلاش کنید.</p><button id="close-modal-btn" class="mt-6 bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition">بستن</button></div></div>
    <script>
(function(){
  function initSimulatorUI(){
    const cs = document.getElementById('consumption-slider');
    const rs = document.getElementById('rainfall-slider');
    const cv = document.getElementById('consumption-value');
    const rv = document.getElementById('rainfall-value');
    if(!cs || !rs || !cv || !rv) return; // DOM not ready or ids wrong

    const sync = () => {
      if (cv && cs) cv.textContent = String(cs.value);
      if (rv && rs) rv.textContent = String(rs.value);
    };

    ['input','change'].forEach(evt => {
      cs.addEventListener(evt, sync, { passive: true });
      rs.addEventListener(evt, sync, { passive: true });
    });

    // مقدار اولیه
    sync();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSimulatorUI, { once:true });
  } else {
    initSimulatorUI();
  }
})();
    </script>
</body>
</html>
